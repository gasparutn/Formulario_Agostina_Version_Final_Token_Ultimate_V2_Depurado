<script>
  // =========================================================
  // ARCHIVO: Eventos.html
  // (MODIFICADO) Añadidas las llamadas a 'toggleSubMetodoCuotas'
  // =========================================================

  document.addEventListener('DOMContentLoaded', () => {

    // --- INICIO DE LISTENERS MOVIDOS ---

    document.getElementById('btn-validar').addEventListener('click', function () {
      const dni = document.getElementById('dni-input').value;
      if (!dni) {
        document.getElementById('status-validacion').innerHTML = '<div class="mensaje error">Por favor, ingrese un DNI.</div>';
        return;
      }
      if (!/^[0-9]{8}$/.test(dni)) {
        document.getElementById('status-validacion').innerHTML = '<div class="mensaje error">Error: El DNI debe tener exactamente 8 dígitos numéricos.</div>';
        return;
      }
      document.getElementById('btn-validar').disabled = true;
      document.getElementById('loader-validacion').style.display = 'block';
      document.getElementById('status-validacion').innerHTML = '';
      google.script.run
        .withSuccessHandler(handleValidationSuccess)
        .withFailureHandler(handleValidationFailure)
        .validarAcceso(dni);
    });

    document.getElementById('fotoCarnet').addEventListener('change', function () {
      manejarSubidaArchivo(this, 'foto', 'fotoCarnetName', 'loader-foto', 'urlFotoCarnet', 'progress-container-foto', 'progress-bar-foto');
    });
    document.getElementById('certificadoAptitud').addEventListener('change', function () {
      manejarSubidaArchivo(this, 'ficha', 'certificadoAptitudName', 'loader-certificado', 'urlCertificadoAptitud', 'progress-container-certificado', 'progress-bar-certificado');
    });

    // (Punto 30) CORRECCIÓN: El listener se adjunta aquí al cargar la página y se cambia a 'input'
    document.getElementById('fechaNacimiento').addEventListener('input', calcularYMostrarEdad);

    document.querySelectorAll('input[name="practicaDeporte"]').forEach(el => el.addEventListener('change', () => toggleEspecifique('practicaDeporte', 'especifiqueDeporte')));
    document.querySelectorAll('input[name="tieneEnfermedad"]').forEach(el => el.addEventListener('change', () => toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad')));
    document.querySelectorAll('input[name="esAlergico"]').forEach(el => el.addEventListener('change', () => toggleEspecifique('esAlergico', 'especifiqueAlergia')));

    // =========================================================
    // --- (INICIO DE LA MODIFICACIÓN) ---
    // =========================================================
    // (Punto 28 y 33) Restaurado: Listener de Pago (Transferencia y Cuotas)
    document.getElementById('metodoPago').addEventListener('change', () => {
      // toggleCantidadCuotas(); // Sigue eliminada
      toggleTransferenciaInfo();
      toggleCuotasInfo();
      toggleSubMetodoCuotas(); // <-- (MODIFICACIÓN) AÑADIDO
      // toggleCuotasTransferenciaInfo(); // <-- (PUNTO 33) ELIMINADO
    });
    // =========================================================
    // --- (FIN DE LA MODIFICACIÓN) ---
    // =========================================================

    // (Punto 28) Restaurado: Copiar Alias
    document.getElementById('btn-copiar-alias').addEventListener('click', function () {
      const alias = document.getElementById('alias-transferencia').textContent;
      navigator.clipboard.writeText(alias).then(() => {
        this.textContent = '¡Copiado!';
        setTimeout(() => { this.textContent = 'Copiar Alias'; }, 2000);
      }).catch(err => {
        alert('Error al copiar: ' + err);
      });
    });

    // (NUEVO - PUNTO 33) Copiar Alias de Cuotas
    document.getElementById('btn-copiar-alias-cuotas').addEventListener('click', function () {
      const alias = document.getElementById('alias-transferencia-cuotas').textContent;
      navigator.clipboard.writeText(alias).then(() => {
        this.textContent = '¡Copiado!';
        setTimeout(() => { this.textContent = 'Copiar Alias'; }, 2000);
      }).catch(err => {
        alert('Error al copiar: ' + err);
      });
    });


    // (Punto 9) Listener Autorizado
    document.getElementById('btn-add-autorizado').addEventListener('click', function () {
      addAutorizadoCampos();
      // guardarFormEnCache();
    });

    // --- (INICIO DE MODIFICACIÓN) ---
    // (MODIFICADO) Listener Hermano ahora abre el MODAL
    document.getElementById('btn-add-hermano').addEventListener('click', function () {
      const dniPrincipal = document.getElementById('dni').value;
      if (!dniPrincipal) {
        alert('Error: El DNI del inscripto principal debe estar cargado.');
        return;
      }
      // Limpiar campos y mensajes anteriores
      document.getElementById('hermano-modal-dni').value = '';
      document.getElementById('status-hermano-modal').innerHTML = '';
      document.getElementById('loader-hermano-modal').style.display = 'none';
      // Mostrar el modal
      document.getElementById('hermano-modal-backdrop').style.display = 'flex';
      document.getElementById('hermano-modal-dni').focus();
    });

    // (NUEVO) Listener para CERRAR el modal de hermano
    document.getElementById('btn-modal-cancelar-hermano').addEventListener('click', function () {
      document.getElementById('hermano-modal-backdrop').style.display = 'none';
    });

    // (NUEVO) Listener para VALIDAR DNI desde el modal
    document.getElementById('btn-modal-validar-hermano').addEventListener('click', function () {
      const btnValidar = this;
      const dniPrincipal = document.getElementById('dni').value; // Ya sabemos que existe
      const dniInput = document.getElementById('hermano-modal-dni');
      const dniHermano = dniInput.value;
      const statusDiv = document.getElementById('status-hermano-modal');
      const loader = document.getElementById('loader-hermano-modal');

      statusDiv.innerHTML = ''; // Limpiar errores previos

      const dniHermanoLimpio = dniHermano.replace(/[.\s-]/g, '').trim();

      if (!/^[0-9]{8}$/.test(dniHermanoLimpio)) {
        statusDiv.innerHTML = `<div class="mensaje error">Error: El DNI debe tener 8 dígitos numéricos.</div>`;
        return;
      }

      if (dniHermanoLimpio === dniPrincipal) {
        statusDiv.innerHTML = `<div class="mensaje error">Error: El DNI del hermano/a no puede ser igual al del inscripto principal.</div>`;
        return;
      }

      // Validar duplicados en el cliente (contra DNIs ya agregados en el formulario)
      const dnisYaAgregados = document.querySelectorAll('.hermano-dni');
      for (const inputDNI of dnisYaAgregados) {
        if (inputDNI.value === dniHermanoLimpio) {
          statusDiv.innerHTML = `<div class="mensaje error">Error: El DNI ${dniHermanoLimpio} ya fue agregado a la lista.</div>`;
          return;
        }
      }

      // Deshabilitar botón y mostrar carga
      btnValidar.disabled = true;
      btnValidar.textContent = 'Validando...';
      loader.style.display = 'block';

      // Llamar a la nueva función del servidor
      google.script.run
        .withSuccessHandler(handleValidacionHermanoSuccess)
        .withFailureHandler(handleValidacionHermanoFailure)
        .validarDNIHermano(dniHermanoLimpio, dniPrincipal);
    });
    // --- (FIN DE MODIFICACIÓN) ---


    // =========================================================
    // (CORRECCIÓN 8 - LISTENER DE SUBMIT)
    // (*** CORREGIDO EL BUG DEL SUBMIT ***)
    // =========================================================
    document.getElementById('registroForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const submitButton = document.getElementById('submit-button');
      const loader = document.getElementById('loader-registro');
      const statusDiv = document.getElementById('status-registro');

      // --- (MODIFICADO) Función helper para manejar fallos de validación ---
      function validationFail(message, elementToFocus) {
        statusDiv.innerHTML = `<div class="mensaje error">${message}</div>`;
        if (elementToFocus) {
          elementToFocus.focus();
          elementToFocus.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        submitButton.disabled = false;
        loader.style.display = 'none';
      }
      // --- (FIN MODIFICADO) ---

      try {
        // --- Iniciar proceso de submit ---
        submitButton.disabled = true;
        loader.style.display = 'block';
        loader.querySelector('p').textContent = 'Validando datos...';
        statusDiv.innerHTML = '';

        const form = e.target;

        // --- 1. Validación Autorizados ---
        const nombresAut = document.querySelectorAll('.autorizado-nombre');
        const dnisAut = document.querySelectorAll('.autorizado-dni');
        let autorizadosValidos = 0;
        let primerInputVacio = null;

        if (nombresAut.length === 0) {
          return validationFail('Error: Debe agregar al menos una persona autorizada.', document.getElementById('btn-add-autorizado'));
        }
        for (let i = 0; i < nombresAut.length; i++) {
          const nombre = nombresAut[i].value.trim();
          const dni = dnisAut[i] ? dnisAut[i].value.trim() : '';

          if (nombre && dni) {
            if (!/^[0-9]{8}$/.test(dni)) {
              return validationFail('Error: El DNI de la persona autorizada (' + nombre + ') debe tener exactamente 8 dígitos numéricos.', dnisAut[i]);
            }
            autorizadosValidos++;
          } else if ((!nombre && dni)) {
            if (!/^[0-9]{8}$/.test(dni)) {
              return validationFail('Error: El DNI de la persona autorizada debe tener 8 dígitos, pero el campo de Nombre está vacío.', dnisAut[i]);
            }
            return validationFail('Error: Por favor complete el Nombre de la persona autorizada.', nombresAut[i]);
          } else if (nombre && !dni) {
            return validationFail('Error: Por favor complete el DNI de la persona autorizada (' + nombre + ') (8 dígitos).', dnisAut[i]);
          }
          if (!nombre && !primerInputVacio) {
            primerInputVacio = nombresAut[i];
          }
        }
        if (autorizadosValidos === 0) {
          return validationFail('Error: Debe ingresar al menos una persona autorizada (Nombre y DNI).', primerInputVacio);
        }

        // --- 1b. Validación Responsable 2 (Opcional) ---
        const adultoResp2Input = document.getElementById('adultoResponsable2');
        const dniResp2Input = document.getElementById('dniResponsable2');
        const adultoResp2 = adultoResp2Input.value.trim();
        const dniResp2 = dniResp2Input.value.trim();

        if (adultoResp2 && !dniResp2) {
          return validationFail('Error: Debe completar el DNI del Responsable 2.', dniResp2Input);
        }
        if (!adultoResp2 && dniResp2) {
          return validationFail('Error: Debe completar el Nombre y Apellido del Responsable 2.', adultoResp2Input);
        }
        if (dniResp2 && !/^[0-9]{8}$/.test(dniResp2)) {
          return validationFail('Error: El DNI del Responsable 2 debe tener exactamente 8 dígitos numéricos.', dniResp2Input);
        }

        // --- 2. Validación 'Especifique' ---
        if (document.querySelector('input[name="practicaDeporte"]:checked')?.value === 'Sí' && !document.getElementById('especifiqueDeporte').value) {
          return validationFail('Debe especificar qué deporte practica.', document.getElementById('especifiqueDeporte'));
        }
        if (document.querySelector('input[name="tieneEnfermedad"]:checked')?.value === 'Sí' && !document.getElementById('especifiqueEnfermedad').value) {
          return validationFail('Debe especificar la enfermedad o medicación.', document.getElementById('especifiqueEnfermedad'));
        }
        if (document.querySelector('input[name="esAlergico"]:checked')?.value === 'Sí' && !document.getElementById('especifiqueAlergia').value) {
          return validationFail('Debe especificar la alergia.', document.getElementById('especifiqueAlergia'));
        }

        // --- 3. Validación Radios Requeridos ---
        const radiosRequeridos = [
          { name: 'practicaDeporte', label: '¿Practica algún deporte...?' },
          { name: 'tieneEnfermedad', label: '¿Tiene alguna enfermedad...?' },
          { name: 'esAlergico', label: '¿Es alérgico/a a algo?' },
          { name: 'esSocio', label: '¿Es Socio del CLUB?' }
        ];
        for (const radio of radiosRequeridos) {
          const checked = document.querySelector(`input[name="${radio.name}"]:checked`);
          if (!checked) {
            const labelEl = document.querySelector(`input[name="${radio.name}"]`).closest('.radio-group').querySelector('label');
            const friendlyName = labelEl ? labelEl.textContent.replace(':', '') : radio.name;
            return validationFail(`Error: Debe seleccionar una opción para "${friendlyName}".`, document.querySelector(`input[name="${radio.name}"]`));
          }
        }

        // --- 3b. (MODIFICADO - PUNTO 38) Validación Edad ---
        const fechaNacInput = document.getElementById('fechaNacimiento');
        const fechaNacPrincipal = fechaNacInput.value;
        if (!fechaNacPrincipal) {
          return validationFail('Error: Debe ingresar una Fecha de Nacimiento.', fechaNacInput);
        }
        if (fechaNacPrincipal < "2010-01-01" || fechaNacPrincipal > "2023-12-31") {
          return validationFail('Error: La fecha de nacimiento debe estar entre 01/01/2010 y 31/12/2023.', fechaNacInput);
        }

        if (fechaNacPrincipal < "2010-01-01" || fechaNacPrincipal > "2023-12-31") {
          return validationFail('Error: La fecha de nacimiento debe estar entre 01/01/2010 y 31/12/2023.', fechaNacInput);
        }

        // --- 3c. (NUEVO) Validación Sub-Método Cuotas ---
        const metodoPago = document.getElementById('metodoPago').value;
        const subMetodo = document.getElementById('subMetodoCuotas');
        if (metodoPago === 'Pago en Cuotas' && subMetodo.required && !subMetodo.value) {
          return validationFail('Error: Debe seleccionar cómo abonará las cuotas (Efectivo o Transferencia).', subMetodo);
        }


        loader.querySelector('p').textContent = 'Recolectando datos...';

        // --- 4. Recolección de Datos ---
        const formDataObject = {};
        document.querySelectorAll('.form-cache').forEach(el => {
          const key = el.id || el.name;
          if (!key) return;
          if (el.disabled) {
            if (el.id === 'jornada') {
              formDataObject['jornada'] = el.value;
            }
            return;
          }
          if (el.type === 'radio') {
            if (el.checked) {
              formDataObject[key] = el.value;
            }
          } else {
            formDataObject[key] = el.value;
          }
        });
        if (formDataObject['metodoPago'] === 'Pago en Cuotas') {
          formDataObject['cantidadCuotas'] = "3";
        }

        // --- 5. Recolección de Datos Faltantes ---
        formDataObject.esHermanoCompletando = (document.getElementById('esHermanoCompletando').value === "true");
        formDataObject.urlCertificadoAptitud = document.getElementById('urlCertificadoAptitud').value;
        formDataObject.urlFotoCarnet = document.getElementById('urlFotoCarnet').value;
        formDataObject.personasAutorizadas = Array.from(nombresAut)
          .map((el, i) => (el.value && dnisAut[i] && dnisAut[i].value) ? `${el.value.trim()} (DNI: ${dnisAut[i].value.trim()})` : null)
          .filter(Boolean)
          .join(', ');

        // Recolección de Hermanos
        formDataObject.hermanos = [];
        const nombresHermano = document.querySelectorAll('.hermano-nombre');
        const apellidosHermano = document.querySelectorAll('.hermano-apellido');
        const obrasSocialesHermano = document.querySelectorAll('.hermano-obrasocial');
        const colegiosHermano = document.querySelectorAll('.hermano-colegio');
        const dnisHermanoInputs = document.querySelectorAll('.hermano-dni');
        const fechasNacHermano = document.querySelectorAll('.hermano-fechanac');
        const tiposHermano = document.querySelectorAll('.hermano-tipo');

        // --- (VALIDACIÓN HERMANOS MODIFICADA) ---
        // Limpiar errores previos
        document.querySelectorAll('.hermano-dni-error').forEach(div => div.textContent = '');

        for (let i = 0; i < dnisHermanoInputs.length; i++) {

          // (*** 1. ESTA ES LA LÍNEA QUE CORRIGE EL BUG ***)
          // Ahora todos los selectores deberían encontrar los elementos
          const nombre = nombresHermano[i].value.trim();
          const apellido = apellidosHermano[i].value.trim();
          const obraSocial = obrasSocialesHermano[i].value.trim();
          const colegio = colegiosHermano[i].value.trim();
          const dniInput = dnisHermanoInputs[i];
          const dni = dniInput.value.trim();
          const fechaNacInputHermano = fechasNacHermano[i]; // Esto ya no es undefined

          // (*** ESTA LÍNEA AHORA ES SEGURA ***)
          const fechaNac = fechaNacInputHermano.value;

          if (!nombre) return validationFail('Error: Debe completar el Nombre del hermano/a (DNI ' + dni + ').', nombresHermano[i]);
          if (!apellido) return validationFail('Error: Debe completar el Apellido del hermano/a (DNI ' + dni + ').', apellidosHermano[i]);
          if (!obraSocial) return validationFail('Error: Debe completar la Obra Social del hermano/a (DNI ' + dni + ').', obrasSocialesHermano[i]);
          if (!colegio) return validationFail('Error: Debe completar el Colegio/Jardín del hermano/a (DNI ' + dni + ').', colegiosHermano[i]);
          if (!fechaNac) return validationFail('Error: Debe completar la Fecha de Nacimiento del hermano/a (DNI ' + dni + ').', fechaNacInputHermano);

          if (fechaNac < "2010-01-01" || fechaNac > "2023-12-31") {
            return validationFail('Error: La fecha de nacimiento del hermano/a (' + nombre + ') debe estar entre 01/01/2010 y 31/12/2023.', fechaNacInputHermano);
          }

          formDataObject.hermanos.push({
            nombre: nombre,
            apellido: apellido,
            obraSocial: obraSocial,
            colegio: colegio,
            dni: dni,
            fechaNac: fechaNac,
            tipo: tiposHermano[i] ? tiposHermano[i].value : 'nuevo'
          });
        }
        // --- (FIN VALIDACIÓN HERMANOS) ---


        // --- 6. Validación de Archivos (Foto y Aptitud) ---
        const urlFoto = formDataObject.urlFotoCarnet;
        const fotoFile = form.fotoCarnet.files[0];
        if (!urlFoto) {
          let msg = '<strong>Error:</strong> Debe seleccionar y subir una Foto Carnet (Requerida).';
          if (fotoFile) {
            msg = '<strong>Error:</strong> La Foto Carnet está seleccionada pero aún no se ha subido.<br>Espere a que la subida finalice (✅) o vuelva a seleccionarla.';
          }
          return validationFail(msg, form.fotoCarnet);
        }
        if (form.certificadoAptitud.files[0] && !formDataObject.urlCertificadoAptitud) {
          let msg = '<strong>Error:</strong> El Certificado de Aptitud se está subiendo o falló.<br>Por favor, espere o vuelva a seleccionarlo.';
          return validationFail(msg, form.certificadoAptitud);
        }

        // --- 7. Envío al Servidor (CORREGIDO) ---
        loader.querySelector('p').textContent = 'Procesando registro... Por favor, espere.';

        google.script.run
          .withSuccessHandler(handlePaso1Success)
          .withFailureHandler(handleRegistroFailure)
          .paso1_registrarRegistro(formDataObject);

      } catch (err) {
        // --- Bloque CATCH general ---
        console.error("Error fatal en el submit:", err);
        validationFail(`Error inesperado en el formulario: ${err.message}. Revise la consola.`);
      }
    });
    // =========================================================
    // (FIN CORRECCIÓN 8)
    // =========================================================

    document.getElementById('btn-limpiar-form').addEventListener('click', function () {
      if (confirm('¿Está seguro de que desea reiniciar el formulario? Se perderán todos los datos cargados.')) {
        limpiarCache();
        window.top.location.href = APP_URL;
      }
    });

    // document.getElementById('registroForm').addEventListener('change', triggerGuardarFormEnCache);

    // --- FIN DE LISTENERS MOVIDOS ---

    // Carga inicial

    // =========================================================
    // --- ¡¡INICIO DE LA CORRECCIÓN DEL BUCLE!! ---
    // =========================================================
    const autoDNI = localStorage.getItem('autoValidateDNI');

    if (autoDNI) {
      // 1. Borrar las claves inmediatamente para detener el bucle
      localStorage.removeItem('autoValidateDNI');

      // 2. Rellenar los campos
      document.getElementById('dni-input').value = autoDNI;

      // 3. Mostrar el loader
      document.getElementById('btn-validar').disabled = true;
      document.getElementById('loader-validacion').style.display = 'block';
      document.getElementById('status-validacion').innerHTML = '<div class="mensaje aviso">Validando DNI del hermano/a...</div>';

      // 4. Llamar a la validación directamente
      // (Usamos un pequeño timeout para asegurar que la UI se actualice)
      setTimeout(() => {
        google.script.run
          .withSuccessHandler(handleValidationSuccess)
          .withFailureHandler(handleValidationFailure)
          .validarAcceso(autoDNI);
      }, 500); // 500ms

    } else {
      // Carga normal si no hay autovalidación
      if (document.querySelectorAll('.autorizado-nombre').length === 0) {
        addAutorizadoCampos();
      }
      cargarFormDesdeCache();
      toggleEspecifique('practicaDeporte', 'especifiqueDeporte');
      toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad');
      toggleEspecifique('esAlergico', 'especifiqueAlergia');
      toggleTransferenciaInfo();
      toggleCuotasInfo();
      // =========================================================
      // --- (INICIO DE LA MODIFICACIÓN) ---
      // =========================================================
      toggleSubMetodoCuotas(); // <-- (MODIFICACIÓN) AÑADIDO
      // =========================================================
      // --- (FIN DE LA MODIFICACIÓN) ---
      // =========================================================
    }
    // =========================================================
    // --- ¡¡FIN DE LA CORRECCIÓN DEL BUCLE!! ---
    // =========================================================


  }); // <-- FIN DEL DOMContentLoaded
</script>