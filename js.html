<script>
  // Variable global para controlar el refresco silencioso
  window.isSilentRefresh = false;

  function handleValidationSuccess(response) {
    document.getElementById('btn-validar').disabled = false;
    document.getElementById('loader-validacion').style.display = 'none';

    // Si es un refresco silencioso (ej. post-upload), saltamos la animación
    if (window.isSilentRefresh) {
      console.log("Refresco silencioso completado (Animación suprimida).");
      window.isSilentRefresh = false;
      processValidationResponse(response);
      return;
    }

    // Mostrar mensaje de bienvenida inline con barra de progreso
    if (response.status.startsWith('OK') || response.status === 'REGISTRO_ENCONTRADO' || response.status === 'HERMANO_COMPLETAR') {
      const statusDiv = document.getElementById('status-validacion');
      const nombre = response.datos?.nombre || '';
      const apellido = response.datos?.apellido || '';

      let titulo = '';
      let mensaje = '';
      let mostrarEstado = false;

      // Determinar si es un registro ya existente (Registros Actuales)
      const esRegistroActual = response.sourceDB === 'Registros Actuales';

      if (esRegistroActual) {
        // Usuario ya registrado - Mostrar estado detallado

        // Determinar estados
        const inscripto = true; // Si está en Registros Actuales, está inscripto
        const adeudaCertificado = response.adeudaAptitud === true;
        const adeudaComprobantes = response.comprobantesCompletos === false;
        const estaCompleto = !adeudaCertificado && !adeudaComprobantes;

        // Título con fondo verde flúor y negrita
        titulo = `<div style="background-color: #b6d7a8; padding: 10px; border-radius: 5px; margin-bottom: 15px;"><strong>¡Hola, ${nombre} ${apellido}!</strong></div>`;

        // Si no adeuda nada, mostrar mensaje de felicitaciones
        if (estaCompleto) {
          mensaje = `<strong>¡Felicitaciones! Tu inscripción está completa.</strong><br><br>
                     ✅ <strong>Inscripto/a:</strong> SÍ<br>
                     ✅ <strong>Certificado de Aptitud Física:</strong> Presentado<br>
                     ✅ <strong>Comprobantes de Pago:</strong> Completos<br><br>
                     <strong>¡Nos vemos en la colonia!</strong>`;
        } else {
          // Mostrar estado con lo que falta
          mensaje = `<strong>Tus datos están en nuestra Base de Datos, tu situación de registro es:</strong><br><br>
                     ✅ <strong>Inscripto/a:</strong> SÍ<br>
                     ${adeudaCertificado
              ? '❌ <strong>Adeuda Certificado de Aptitud Física:</strong> SÍ'
              : '✅ <strong>Certificado de Aptitud Física:</strong> Presentado'}<br>
                     ${adeudaComprobantes
              ? '❌ <strong>Adeuda Comprobantes de Pago:</strong> SÍ'
              : '✅ <strong>Comprobantes de Pago:</strong> Completos'}<br><br>
                     ${(adeudaCertificado || adeudaComprobantes)
              ? '<strong>Por favor, complete la documentación faltante para confirmar su inscripción.</strong>'
              : ''}`;
        }
        mostrarEstado = true;

        // Crear HTML del mensaje con barra de progreso
        const mensajeProgreso = estaCompleto ? 'Cerrando formulario...' : 'Apertura de datos...';

        statusDiv.innerHTML = `
          <div class="mensaje exito" style="background-color: #fff9c4; border: 2px solid #fbc02d; border-radius: 8px; text-align: center; padding: 20px;">
            ${titulo}
            <p style="color: #333; margin-bottom: 20px; line-height: 1.6; text-align: left;">${mensaje}</p>
            <p style="font-weight: bold; color: #f57c00; margin-bottom: 10px;">${mensajeProgreso}</p>
            <div style="width: 100%; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; height: 20px;">
              <div id="progress-bar-validation" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.1s linear;"></div>
            </div>
          </div>
        `;

        // Animar barra de progreso (6 segundos)
        let progress = 0;
        const progressBar = document.getElementById('progress-bar-validation');
        const interval = setInterval(() => {
          progress += 1.67; // 100% en 6 segundos (60 iteraciones * 100ms)
          if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            // Después de completar
            setTimeout(() => {
              if (estaCompleto) {
                // Si está completo, mostrar mensaje final sin botón
                statusDiv.innerHTML = `
                  <div class="mensaje exito" style="background-color: #fff9c4; border: 2px solid #fbc02d; border-radius: 8px; text-align: center; padding: 30px;">
                    <h3 style="color: white; background-color: #4CAF50; padding: 15px; border-radius: 8px; margin-bottom: 20px;">✅ ¡Inscripción Completa!</h3>
                    <p style="color: #333; margin-bottom: 20px; font-size: 18px; line-height: 1.8;">
                      <strong>¡Felicitaciones!</strong><br>
                      Tu inscripción está completa y confirmada.<br>
                      ¡Nos vemos en la colonia!
                    </p>
                  </div>
                `;
              } else {
                // Si falta algo, mostrar el formulario
                processValidationResponse(response);
              }
            }, 300);
          }
          progressBar.style.width = progress + '%';
        }, 100);

        return; // Salir aquí para evitar ejecutar el código de abajo
      } else {
        // Nuevos registros o Pre-venta
        switch (response.sourceDB) {
          case 'Preventa':
            titulo = 'Registro de Preventa Encontrado';
            mensaje = `Hemos encontrado en nuestra Base de Datos de Preventa al siguiente inscripto/a:<br><br>
                       Nombres: <strong style="color: #d32f2f;">${nombre}</strong>.<br>
                       Apellidos: <strong style="color: #d32f2f;">${apellido}</strong>.<br><br>
                       Se abrirá el formulario para completar todos los datos de su hijo/a, incluyendo hermanos.<br>
                       Recuerde completar todas las instancias del registro y cargar los comprobantes de pago para que la inscripción esté confirmada.<br>
                       ¡Muchas gracias!`;
            break;
          case 'Inscriptos Anteriores':
            titulo = 'Registro Anterior Encontrado';
            mensaje = `Hemos encontrado en nuestra Base de Datos del año anterior al siguiente inscripto/a:<br><br>
                       Nombres: <strong style="color: #d32f2f;">${nombre}</strong>.<br>
                       Apellidos: <strong style="color: #d32f2f;">${apellido}</strong>.<br><br>
                       Se procederá a la apertura del formulario. Recuerde completar todas las instancias del registro y cargar los comprobantes de pago para que la inscripción esté confirmada.<br>
                       ¡Muchas gracias!`;
            break;
          case 'Nuevo Inscripto':
            // Título simple sin div interno
            titulo = 'Nuevo Registro';
            mensaje = `<div style="line-height: 1.0; text-align: center;"><strong>No se encuentra el DNI en nuestras bases de datos.</strong><br><br>
                       Por favor, complete todos los datos del formulario y cargue los comprobantes de pago para que la inscripción esté confirmada.<br><br>
                       <strong>¡Muchas gracias!</strong></div>`;
            mostrarEstado = false; // Centrado
            break;
          default:
            titulo = `¡Hola, <strong style="color: #d32f2f;">${nombre} ${apellido}</strong>!`;
            mensaje = `Hemos encontrado tus datos en: <strong>${response.sourceDB}</strong>.<br><br>
                       Recuerde completar todas las instancias del registro y cargar los comprobantes de pago para que la inscripción esté confirmada.<br>
                       ¡Muchas gracias!`;
        }
      }

      // Crear HTML del mensaje con barra de progreso
      statusDiv.innerHTML = `
        <div class="mensaje exito" style="background-color: #fff9c4; border: 2px solid #fbc02d; border-radius: 8px; text-align: center; padding: 20px;">
          <h3 style="color: ${response.sourceDB === 'Nuevo Inscripto' ? 'white' : '#f57c00'}; 
                     background-color: ${response.sourceDB === 'Nuevo Inscripto' ? '#2196F3' : 'transparent'}; 
                     padding: ${response.sourceDB === 'Nuevo Inscripto' ? '15px' : '0'}; 
                     border-radius: ${response.sourceDB === 'Nuevo Inscripto' ? '5px' : '0'}; 
                     margin-bottom: 15px; 
                     font-size: ${response.sourceDB === 'Nuevo Inscripto' ? '20px' : '1.5em'};">${titulo}</h3>
          <p style="color: #333; margin-bottom: 20px; line-height: 1.6; text-align: ${mostrarEstado ? 'left' : 'center'};">${mensaje}</p>
          <p style="font-weight: bold; color: #f57c00; margin-top: 40px; margin-bottom: 10px;">Apertura de datos...</p>
          <div style="width: 100%; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; height: 20px;">
            <div id="progress-bar-validation" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.1s linear;"></div>
          </div>
        </div>
      `;

      // Animar barra de progreso
      let progress = 0;
      const progressBar = document.getElementById('progress-bar-validation');
      const interval = setInterval(() => {
        progress += 1.67; // 100% en 6 segundos (60 iteraciones * 100ms)
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          // Después de completar, mostrar el formulario
          setTimeout(() => {
            processValidationResponse(response);
          }, 300);
        }
        progressBar.style.width = progress + '%';
      }, 100);

    } else {
      processValidationResponse(response);
    }
  }

  // ... (resto del código) ...

  function handleComprobanteUploadSuccess(response) {
    const statusDiv = document.getElementById('status-validacion');
    const fileInputComprobante = document.getElementById('comprobante-manual-upload');
    const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
    const btnFinalizar = document.getElementById('btn-finalizar-upload');
    const loaderComprobante = document.getElementById('loader-comprobante');

    const submitButton = document.getElementById('btn-submit-comprobante-manual');
    if (submitButton && submitButton.dataset.progressInterval) {
      clearInterval(parseInt(submitButton.dataset.progressInterval));
    }

    const progressContainer = document.getElementById('progress-container-comprobante');
    const progressBar = document.getElementById('progress-bar-comprobante');

    if (progressBar) {
      progressBar.style.width = '100%';
      progressBar.textContent = '100%';
      progressBar.style.backgroundColor = '#28a745'; // Green for success
    }

    if (progressContainer) {
      setTimeout(() => {
        progressContainer.style.display = 'none';
      }, 500); // Wait half a second before hiding
    }

    loaderComprobante.style.display = 'none'; // Ensure spinner is hidden
    statusDiv.querySelectorAll('.mensaje').forEach(el => {
      // No borrar el mensaje de 'adeuda aptitud'
      if (el.closest && !el.closest('#aptitud-manual-seccion')) {
        el.remove();
      } else if (!el.closest) {
        el.remove();
      }
    });

    if (response.status === 'OK') {
      // --- INICIO DE LA MODIFICACIÓN (ASYNC OCR + SILENT REFRESH ROBUSTO) ---
      // Mostrar mensaje de éxito inmediato
      statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje exito" style="margin-bottom:10px;">${response.message}</div>`);

      // Si el servidor nos devuelve datos para OCR, lanzamos el proceso en segundo plano
      if (response.fileId) {
        console.log("Iniciando OCR asíncrono...", response);
        // Mostrar un indicador visual discreto de que se está analizando
        const loaderValidacion = document.getElementById('loader-validacion');
        if (loaderValidacion) {
          loaderValidacion.style.display = 'block';
          loaderValidacion.querySelector('p').textContent = 'Analizando comprobante con IA... (Puede cerrar esta ventana)';
        }

        // Llamada asíncrona al OCR
        google.script.run
          .withSuccessHandler(function (resOCR) {
            console.log("OCR Finalizado:", resOCR);

            // Una vez terminado el OCR, refrescamos la validación para mostrar los colores
            const dni = document.getElementById('dni-input').value;

            // Usamos un wrapper para asegurar que el flag se mantenga
            window.isSilentRefresh = true;
            google.script.run
              .withSuccessHandler(function (resp) {
                window.isSilentRefresh = true; // Reforzar flag justo antes de llamar al handler
                handleValidationSuccess(resp);
              })
              .withFailureHandler(handleValidationFailure)
              .validarAcceso(dni);
          })
          .withFailureHandler(function (err) {
            console.error("Error en OCR Async:", err);
            // Incluso si falla el OCR, refrescamos para mostrar el error en la celda (amarillo)
            const dni = document.getElementById('dni-input').value;
            window.isSilentRefresh = true;
            google.script.run
              .withSuccessHandler(function (resp) {
                window.isSilentRefresh = true;
                handleValidationSuccess(resp);
              })
              .validarAcceso(dni);
          })
          .procesarOCRAsync(response.fileId, response.fila, response.precioEsperado, response.esFamiliar, response.filasFamiliares);
      } else {
        console.warn("No se requiere OCR (sin fileId). Respuesta:", response);
        // Si no hay OCR (ej. no se requería), refrescamos directo
        setTimeout(() => {
          const dni = document.getElementById('dni-input').value;
          window.isSilentRefresh = true;
          google.script.run
            .withSuccessHandler(function (resp) {
              window.isSilentRefresh = true;
              handleValidationSuccess(resp);
            })
            .withFailureHandler(handleValidationFailure)
            .validarAcceso(dni);
        }, 2000);
      }

      // Ocultar la sección de subida de comprobante
      const comprobanteSection = document.getElementById('comprobante-manual-seccion');
      if (comprobanteSection) {
        comprobanteSection.style.display = 'none';
      }
      // --- FIN DE LA MODIFICACIÓN ---

    } else { // Si response.status es 'ERROR'
      statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje error" style="margin-bottom:10px;">${response.message}</div>`);
      if (btnSubmitComprobante) btnSubmitComprobante.disabled = false;
      if (fileInputComprobante) fileInputComprobante.disabled = false;
      if (btnFinalizar) btnFinalizar.disabled = false;
    }
  }
  // =========================================================
  // ARCHIVO: js.html
  // Lógica Principal, Handlers del Servidor y Orquestación
  // (MODIFICADO v20)
  // - Corregido un error de sintaxis (una 'D' perdida) en el
  //   manejador de error de 'submitAptitudManual' que causaba
  //   que el script no cargara y el validador girara indefinidamente.
  // =========================================================

  const APP_URL = GLOBAL_APP_URL;
  const PAGO_TOTAL_MP_VISIBLE = GLOBAL_PAGO_TOTAL_MP_VISIBLE;
  const CACHE_KEY = 'formDataCache';
  let numeroDeTurnoGuardado = null;
  let datosEdicionGlobales = null;

  // =========================================================
  // DEFINICIONES DE FUNCIONES DE RESPUESTA (HANDLERS)
  // =========================================================

  function handleRegistroFailure(error) {
    document.getElementById('submit-button').disabled = false;
    document.getElementById('loader-registro').style.display = 'none';
    const errorMessage = error.message || 'Ocurrió un error desconocido al registrar.';
    document.getElementById('status-registro').innerHTML = `<div class="mensaje error"><strong>Error al Registrar:</strong> ${errorMessage}</div>`;
  }

  function handlePaso1Success(response) {
    try {
      // Defensa: comprobar que venga un objeto
      if (!response || typeof response !== 'object') {
        console.error('Respuesta inválida del servidor en paso1:', response);
        handleRegistroFailure({ message: 'Respuesta inesperada del servidor. Reintente y copie los logs de la consola.' });
        return;
      }

      if (!response.status) {
        console.error('Respuesta sin campo status en paso1:', response);
        handleRegistroFailure({ message: 'Respuesta del servidor incompleta. Revise los logs.' });
        return;
      }

      if (response.status === 'OK_REGISTRO') {
        // Registro creado/actualizado correctamente
        registroResultado = response;
        // Llamar al servidor para el paso 2 (usar google.script.run)
        document.getElementById('loader-registro').querySelector('p').textContent = 'Finalizando registro...';
        google.script.run
          .withSuccessHandler(handlePagoSuccess)
          .withFailureHandler(handlePagoFailure)
          .paso2_procesarPostRegistro(response.datos, response.numeroDeTurno, response.hermanosRegistrados);
      } else {
        console.warn('Paso1 devolvió status distinto de OK_REGISTRO:', response.status, response);
        handleRegistroFailure(response);
      }
    } catch (err) {
      console.error('Error manejando la respuesta de paso1:', err, response);
      handleRegistroFailure({ message: 'Error procesando la respuesta del servidor. Revise la consola para más detalles.' });
    }
  }

  /**
  * (CORREGIDO)
  * - Añadido el botón "Volver al Formulario" al HTML de respuesta.
  * - Añadido el event listener para ese botón.
  */
  function handlePagoSuccess(response) {
    document.getElementById('registroForm').style.display = 'none';
    document.getElementById('loader-registro').style.display = 'none';
    const statusDiv = document.getElementById('status-registro');
    const dniJustRegistered = response.dniRegistrado;
    let listFromCache = JSON.parse(localStorage.getItem('pendingSiblings') || 'null');
    let listToDisplay = [];
    let isFinalRegistration = false;

    if (listFromCache) {
      listToDisplay = listFromCache.filter(h => h.dni !== dniJustRegistered);
      if (listToDisplay.length === 0) isFinalRegistration = true;
    } else if (response.hermanos && response.hermanos.length > 0) {
      listToDisplay = response.hermanos;
    }

    let htmlHermanos = '';
    if (isFinalRegistration) {
      localStorage.removeItem('pendingSiblings');
      htmlHermanos = `<div class="hermanos-post-registro; text-align:justify"><h4>¡Registro Familiar Completo!</h4><p>Todos los hermanos/as han sido registrados exitosamente.</p></div>`;
    } else if (listToDisplay.length > 0) {
      localStorage.setItem('pendingSiblings', JSON.stringify(listToDisplay));
      htmlHermanos = `<div class="hermanos-post-registro"><h4>¡Atención! Hermanos/as Pendientes</h4><p>El registro de <strong>${response.datos.nombre} ${response.datos.apellido}</strong> fue exitoso.</p><p>Quedan los siguientes hermanos/as por completar (requieren sus propios datos de salud, fotos, etc.):</p><ul>`;
      listToDisplay.forEach(h => {
        htmlHermanos += `<li>${h.nombre} ${h.apellido} (DNI: ...${h.dni.slice(-3)}) <button type="button" class="btn-completar-hermano" data-dni="${h.dni}" data-tipo="${h.tipo}">Completar Datos Ahora</button></li>`;
      });
      htmlHermanos += `</ul><p>Puede completar sus datos ahora (recomendado) o volver a esta página más tarde e ingresar el DNI del hermano/a para validarlo.</p></div>`;
    } else {
      localStorage.removeItem('pendingSiblings');
    }

    // --- INICIO DE LA CORRECCIÓN ---
    // 1. Definir el HTML del botón que faltaba
    const botonVolverHTML = `
      <button type="button" id="btn-volver-limpiar-final" class="btn-final-volver" style="background-color: var(--color-principal); margin-top: 20px;">
        Volver al Formulario</button>`;
    // --- FIN DE LA CORRECCIÓN ---

    if (response && (response.status === 'OK_EFECTIVO' || response.status === 'OK_REGISTRO_SIN_PAGO')) {
      // 2. Añadir el botón al HTML
      statusDiv.innerHTML = `<div class="mensaje exito">${response.message}</div>${htmlHermanos}${botonVolverHTML}`;
    } else {
      const errorMessage = response.message || 'Ocurrió un error desconocido en el paso 2.';
      // 2. Añadir el botón también en caso de error
      statusDiv.innerHTML = `<div class="mensaje error"><strong>Error:</strong> ${errorMessage}</div>${htmlHermanos}${botonVolverHTML}`;
    }

    document.querySelectorAll('.btn-completar-hermano').forEach(btn => {
      btn.addEventListener('click', function () {
        localStorage.setItem('autoValidateDNI', this.dataset.dni);
        window.top.location.href = APP_URL;
      });
    });

    // --- INICIO DE LA CORRECCIÓN ---
    // 3. Añadir el listener para el nuevo botón
    const btnVolver = document.getElementById('btn-volver-limpiar-final');
    if (btnVolver) {
      btnVolver.addEventListener('click', function () {
        limpiarCache(); // Función de js2.html
        window.top.location.href = APP_URL; // Constante global
      });
    }
    // --- FIN DE LA CORRECCIÓN ---
  }

  function handlePagoFailure(error) {
    document.getElementById('submit-button').disabled = false;
    document.getElementById('loader-registro').style.display = 'none';
    const errorMessage = error.message || error;
    document.getElementById('status-registro').innerHTML = `<div class="mensaje aviso"><strong>¡¡REGISTRO GUARDADO!!</strong><br>Pero ocurrió un error al finalizar el registro: ${errorMessage}.<br>Por favor, contacte a la administración con su número de turno si el problema persiste.</div>`;
  }

  function handleValidacionHermanoSuccess(response) {
    document.getElementById('loader-hermano-modal').style.display = 'none';
    const btnValidar = document.getElementById('btn-modal-validar-hermano');
    btnValidar.disabled = false;
    btnValidar.textContent = 'Validar DNI';
    const statusDiv = document.getElementById('status-hermano-modal');

    if (response.status.startsWith('OK_')) {
      statusDiv.innerHTML = `<div class="mensaje exito">${response.message}</div>`;

      // =========================================================
      // --- ¡¡INICIO DE LA CORRECCIÓN!! ---
      // (Aquí pasamos el tipo 'nuevo', 'anterior' o 'preventa' a la función)
      // =========================================================
      addHermanoCampos(response.datos, response.datos.tipo);
      // =========================================================
      // --- ¡¡FIN DE LA CORRECCIÓN!! ---
      // =========================================================

      // guardarFormEnCache();
      setTimeout(() => {
        document.getElementById('hermano-modal-backdrop').style.display = 'none';
        statusDiv.innerHTML = '';
        document.getElementById('hermano-modal-dni').value = '';
      }, 3500);
    } else {
      statusDiv.innerHTML = `<div class="mensaje error">${response.message}</div>`;
    }
  }

  function handleValidacionHermanoFailure(error) {
    document.getElementById('loader-hermano-modal').style.display = 'none';
    const btnValidar = document.getElementById('btn-modal-validar-hermano');
    btnValidar.disabled = false;
    btnValidar.textContent = 'Validar DNI';
    document.getElementById('status-hermano-modal').innerHTML = `<div class="mensaje error">Error de conexión: ${error.message}</div>`;
  }

  /**
  * (MODIFICADO)
  * - (NUEVO) Añadido un chequeo al inicio para mostrar el modal de "Completado".
  * - Corrige los mensajes para "Pago en Cuotas" pendiente.
  * - Utiliza 'response.cuotasPendientes' y 'response.cuotasPagadas'
  * - Deshabilita los checkboxes de cuotas ya pagadas.
  * - Corrige bug 'undefined undefined' usando `response.datos.nombre` y `apellido`.
  * - (MODIFICADO) Muestra la casilla "familiar" y corrige la lógica de habilitación.
  */
  function processValidationResponse(response) {
    document.getElementById('loader-validacion').style.display = 'none';
    const statusDiv = document.getElementById('status-validacion');
    if (response.datos) datosEdicionGlobales = response.datos;

    if (response.status === 'HERMANO_COMPLETAR') {
      statusDiv.innerHTML = `<div class="mensaje aviso" style="text-align: left;">${response.message}</div>`;
      document.getElementById('esHermanoCompletando').value = "true";
      if (document.getElementById('seccion-hermanos')) document.getElementById('seccion-hermanos').style.display = 'none';
      // Directamente mostrar el formulario, saltando el temporizador para mayor robustez.
      mostrarFormulario(response);
    } else if (response.status === 'OK_PREVENTA' || response.status === 'OK_ANTERIOR' || response.status === 'OK_NUEVO') {
      document.getElementById('esHermanoCompletando').value = "false";
      if (document.getElementById('seccion-hermanos')) document.getElementById('seccion-hermanos').style.display = 'block';
      // Directamente mostrar el formulario, saltando el temporizador para mayor robustez.
      mostrarFormulario(response);
    } else if (response.status === 'REGISTRO_ENCONTRADO') {
      let html = '';

      // --- (INICIO CORRECCIÓN MENSAJES) ---
      // (Arregla "undefined undefined")
      const nombreCompleto = (response.datos && response.datos.nombre) ? `${response.datos.nombre} ${response.datos.apellido}` : 'Usuario';

      // CASO 1: 100% COMPLETO (Pagos Y Aptitud)
      // Esta es la nueva lógica que pediste
      if (response.comprobantesCompletos === true && response.adeudaAptitud === false) {
        html += `<div class="mensaje exito" style="margin-bottom:10px; text-align:center;">
              <strong>¡Felicidades, ${nombreCompleto}!</strong>
              <br>Has completado exitosamente todo el proceso de inscripción!!!
            </div>`;
      }
      // CASO 2: Pagos completos, PERO AÚN DEBE APTITUD
      else if (response.comprobantesCompletos === true && response.adeudaAptitud === true) {
        html += `<div class="mensaje exito" style="margin-bottom:10px; text-align:left;">
               <strong>✅ ¡Pagos Completos! (${nombreCompleto})</strong>
               <br>Ya has completado todos los pagos. Solo falta subir el Certificado de Aptitud Física.
             </div>`;
      }
      // CASO 3: Aún debe pagos (y es "Pago en Cuotas")
      else if (response.metodoPago === 'Pago en Cuotas') {
        const cantCuotas = response.cantidadCuotasRegistrada || 3;
        const pendientes = typeof response.cuotasPendientes === 'number' ? response.cuotasPendientes : 0;

        // (CASO 3a: Es "Pago en Cuotas" pero pagó todo y está "en revisión". Muestra el msg de la screenshot)
        // Este es el bloque que estabas viendo
        if (pendientes === 0) {
          html += `<div class="mensaje aviso" style="margin-bottom:10px; text-align:justify;"><strong>"Recuerde subir comprobante de transferencia o comprobante de pago efectivo otorgado por el CLUB, validando nuevamente por el formulario con el dni del inscripto/a". Cualquier duda que surja no dude en comunicarse con la Administración. Muchas Gracias!!</strong></div>`;
        }
        // (CASO 3b: Aún debe cuotas)
        else {
          let cuotaMsg = `Tiene ${pendientes} cuota${pendientes !== 1 ? 's' : ''} pendiente${pendientes !== 1 ? 's' : ''} de ${cantCuotas}.`;

          // Si el estado es "Pago Cuota 1" o "En revisión", se muestra
          if (response.estadoPago && (response.estadoPago.includes('En revisión') || response.estadoPago.includes('Pago Cuota'))) {
            cuotaMsg = `Su estado de pago es: <strong>${response.estadoPago}</strong>. ${cuotaMsg}`;
          }

          html += `<div class="mensaje aviso" style="margin-bottom:10px; text-align:justify;"><strong>⚠️ ${nombreCompleto} ya se encuentra REGISTRADO.</strong><br>${cuotaMsg}</div>`;
        }
      }
      // CASO 4: Aún debe pagos (Transferencia/Efectivo)
      else {
        // Reemplaza el nombre "undefined undefined" en el mensaje del servidor
        const mensajeCorregido = response.message.replace('undefined undefined', nombreCompleto);
        html += `<div class="mensaje aviso" style="margin-bottom:10px; text-align:left;"><strong>${mensajeCorregido}</strong></div>`;
      }
      // --- (FIN CORRECCIÓN MENSAJES) ---

      if (response.adeudaAptitud === true) {
        html += `<div id="aptitud-manual-seccion" style="margin-top: 15px; padding: 10px; border: 1px solid #e67e22; border-radius: 5px; background: #fdf5e6;"><h3>¡Atención!</h3><p style="text-align: center; font-weight: bold; color: #e67e22;">Adeuda Certificado de Aptitud Física</p><p>Por favor, suba el certificado para completar la ficha.</p><label for="aptitud-manual-upload" class="file-input-label" style="background-color: #e67e22;">Seleccionar Certificado</label><input type="file" id="aptitud-manual-upload" accept="image/jpeg, image/png, application/pdf"><span id="aptitud-manual-name" class="file-name">Ningún archivo seleccionado</span><button type="button" id="btn-submit-aptitud-manual" style="background-color: #e67e22; width: 100%; height:45px">Subir Certificado!!!</button><div class="loader" id="loader-aptitud" style="display: none;"><div class="spinner"></div><p>Subiendo...</p></div></div>`;
      }

      // Decidir si mostrar la sección de comprobantes basándonos en datos autoritativos
      const metodoPagoResp = response.metodoPago || '';
      const cuotasPendientesParaUI = (typeof response.cuotasPendientes === 'number') ? response.cuotasPendientes : (response.cantidadCuotasRegistrada || 0);
      const comprobantesCompletos = !!response.comprobantesCompletos;
      const debeMostrarComprobanteSection = (metodoPagoResp === 'Pago en Cuotas') ? (cuotasPendientesParaUI > 0) : (!comprobantesCompletos);

      if (debeMostrarComprobanteSection) {
        html += `<div id="comprobante-manual-seccion" style="margin-top: 15px; border: 1px solid var(--color-principal); padding: 15px; border-radius: 5px;"><h3>Subir un comprobante (Cuota, Transferencia, etc.):</h3>`;

        // --- (INICIO MODIFICACIÓN MENSAJE CUOTAS) ---
        if (response.metodoPago === 'Pago en Cuotas') {
          if (response.tieneHermanos) {
            html += `<div class="mensaje-cuota">Recuerde que si está tildado la opción (comprobante elegido que incluye Hermanos/as), usted está informando que esta cargando un comprobante de pago por el total de cada Cuota que incluye al total de los hijo/as registrados.<br><strong></div>`;
          } else {
            const cantCuotas = response.cantidadCuotasRegistrada || 3;
            const pendientes = response.cuotasPendientes;

          }
        }
        // --- (FIN MODIFICACIÓN MENSAJE CUOTAS) ---

        // (Selector de tipo de pago)
        html += `<label for="tipo-comprobante-select" class="titulo-seccion-comprobante"><b>Seleccione el tipo de comprobante:</b></label><select id="tipo-comprobante-select"><option value="">-- Elija una opción --</option><option value="mp_cuotas_group" style="display: ${response.metodoPago === 'Pago en Cuotas' ? 'block' : 'none'};">b) Comprobante Pagos 3 cuotas</option><option value="externo" style="display: ${response.metodoPago !== 'Pago en Cuotas' ? 'block' : 'none'};">c) Comprobante Externo (Transferencia, etc.)</option></select>`;

        // --- (INICIO MODIFICACIÓN CHECKBOXES - DESHABILITAR PAGADAS) ---
        const cuotasPagadas = response.cuotasPagadas || [];
        const c1_pagada = cuotasPagadas.includes('mp_cuota_1');
        const c2_pagada = cuotasPagadas.includes('mp_cuota_2');
        const c3_pagada = cuotasPagadas.includes('mp_cuota_3');

        html += `<div id="cuota-selector-container" style="display: none; margin-top: 10px;">
        <label class="titulo-seccion-comprobante"><b>Seleccione la/s cuota/s que pagó con este comprobante:</b></label>
        <div class="cuota-checkbox-container">
          <div class="cuota-checkbox-item">
            <input type="checkbox" id="cuota-check-1" value="mp_cuota_1" ${c1_pagada ? 'disabled' : ''}>
            <label for="cuota-check-1" class="${c1_pagada ? 'disabled' : ''}">b.1) Comprobante Cuota 1 ${c1_pagada ? '<strong>(Ya Pagada)</strong>' : ''}</label>
          </div>
          <div class="cuota-checkbox-item">
            <input type="checkbox" id="cuota-check-2" value="mp_cuota_2" ${c2_pagada ? 'disabled' : ''}>
            <label for="cuota-check-2" class="${c2_pagada ? 'disabled' : ''}">b.2) Comprobante Cuota 2 ${c2_pagada ? '<strong>(Ya Pagada)</strong>' : ''}</label>
          </div>
          <div class="cuota-checkbox-item">
            <input type="checkbox" id="cuota-check-3" value="mp_cuota_3" ${c3_pagada ? 'disabled' : ''}>
            <label for="cuota-check-3" class="${c3_pagada ? 'disabled' : ''}">b.3) Comprobante Cuota 3 ${c3_pagada ? '<strong>(Ya Pagada)</strong>' : ''}</label>
          </div>
        </div>
      </div>`;
        // --- (FIN MODIFICACIÓN CHECKBOXES) ---

        // (Datos Pagador y Checkbox Familiar)

        html += `<div id="datos-externo-container"><label for="externo-nombre-pagador" class="titulo-seccion-comprobante"><b>Nombre y Apellido (del Adulto Pagador):</b></label><input type="text" id="externo-nombre-pagador" placeholder="Nombre Apellido (Quien paga)"><label for="externo-dni-pagador">DNI (del Adulto Pagador):</label><input type="tel" id="externo-dni-pagador" placeholder="DNI (Quien paga)" pattern="[0-9]{8}" inputmode="numeric" maxlength="8" title="El DNI debe tener exactamente 8 dígitos numéricos.">

              <div id="sub-metodo-cuotas-comprobante-container" style="display: none; margin-top: 15px;">
                <label class="titulo-seccion-comprobante"><b>Indique cómo pagó la cuota:</b></label>
                <div class="checkbox-option">
                  <input type="checkbox" id="subMetodoEfectivo" name="subMetodoCuotasComprobante" value="Efectivo">
                  <label for="subMetodoEfectivo">a) Pagué cuota efectivo en Adm. del Club.</label>
                </div>
                <div class="checkbox-option">
                  <input type="checkbox" id="subMetodoTransferencia" name="subMetodoCuotasComprobante" value="Transferencia">
                  <label for="subMetodoTransferencia">b) Pagué con Transferencia(Bancaria, MP,etc.)</label>
                </div>
              </div>

              <div id="pago-familiar-container" style="display: ${response.tieneHermanos ? 'flex' : 'none'};">
                <input type="checkbox" id="es-pago-familiar-check">
                <label for="es-pago-familiar-check">Tilde la opción si el comprobante elegido incluye a los/as (hermanos/as)?</label>
              </div>
              </div>`;



        // (Botón de Subida)

        html += `<div id="upload-file-container"><label for="comprobante-manual-upload" class="file-input-label" style="background-color: #7f8c8d;">Seleccionar Archivo para Subir</label><input type="file" id="comprobante-manual-upload" accept="image/jpeg, image/png, application/pdf"><div style="display: flex; align-items: center; margin-bottom: 15px;"><span id="comprobante-manual-name" class="file-name" style="margin-bottom: 0;">Ningún archivo seleccionado</span><button type="button" id="btn-clear-comprobante" class="btn-remover" style="display:none; margin-top: 0; margin-left: 10px;">X</button></div><button type="button" id="btn-submit-comprobante-manual">Subir Comprobante</button><div id="progress-container-comprobante" style="display: none; margin-top: 15px;"><div id="progress-bar-comprobante">0%</div></div><div class="loader" id="loader-comprobante" style="display: none; margin-top: 15px;"><div class="spinner"></div><p>Subiendo comprobante...</p></div></div><hr style="margin-top:20px;"><button type="button" id="btn-finalizar-upload" class="btn-final-volver">Finalizar Carga (Volver)</button></div>`;



      } else { // Si está pagado Y no adeuda aptitud

        if (response.adeudaAptitud !== true) {

          // (Este botón ya no se muestra, porque el modal de "Completado" aparece en su lugar)

          // html += `<button type="button" id="btn-finalizar-upload" class="btn-final-volver">Volver al Inicio</button>`;

        }

      }



      // (Sección Editar)

      html += `<div id="editar-info-seccion" style="margin-top: 20px;">
              <button type="button" id="btn-mostrar-editar" class="btn-editar">Editar Datos de Contacto / Salud / Autorizados</button>
              <div id="editar-form-container" style="display: none;">
                <div class="edit-header">
                  <h3>Editando Datos</h3>
                  <div id="edit-timer"></div>
                </div>
                <p>Modifique solo los campos necesarios. Los campos de DNI e Email del inscripto no se pueden cambiar.</p>
                
                <div class="edit-grid">
                  <div class="edit-grid-item">
                    <label for="edit-dni">DNI Inscripto (Bloqueado)</label>
                    <input type="text" id="edit-dni" readonly class="campo-bloqueado">
                  </div>
                  <div class="edit-grid-item">
                    <label for="edit-email">Email (Bloqueado)</label>
                    <input type="email" id="edit-email" readonly class="campo-bloqueado">
                  </div>

                  <div class="edit-grid-item-group">
                    <div class="edit-grid-item">
                      <label for="edit-adultoResponsable1">Adulto Responsable 1</label>
                      <input type="text" id="edit-adultoResponsable1" class="form-cache">
                    </div>
                    <div class="edit-grid-item">
                      <label for="edit-dniResponsable1">DNI Responsable 1</label>
                      <input type="tel" id="edit-dniResponsable1" class="form-cache" maxlength="8" pattern="[0-9]{8}">
                    </div>
                    <div class="edit-grid-item">
                      <label>Tel. Responsable 1</label>
                      <div class="telefono-container">
                        <input type="tel" id="edit-telAreaResp1" placeholder="Cod. Área (sin 0)" pattern="^[1-9][0-9]{1,4}$" title="Cod. Área sin 0">
                        <input type="tel" id="edit-telNumResp1" placeholder="Número (sin 15)" pattern="^[0-9]{6,10}$" title="Número sin 15">
                      </div>
                    </div>
                  </div>

                  <div class="edit-grid-item-group">
                    <div class="edit-grid-item">
                      <label for="edit-adultoResponsable2">Adulto Responsable 2 (Opcional)</label>
                      <input type="text" id="edit-adultoResponsable2" class="form-cache">
                    </div>
                    <div class="edit-grid-item">
                      <label for="edit-dniResponsable2">DNI Responsable 2 (Opcional)</label>
                      <input type="tel" id="edit-dniResponsable2" class="form-cache" maxlength="8" pattern="[0-9]{8}">
                    </div>
                    <div class="edit-grid-item">
                       <label>Tel. Responsable 2 (Opcional)</label>
                       <div class="telefono-container">
                         <input type="tel" id="edit-telAreaResp2" placeholder="Cod. Área (sin 0)">
                         <input type="tel" id="edit-telNumResp2" placeholder="Número (sin 15)">
                       </div>
                    </div>
                  </div>
                </div>

                <hr>
                <h4>Datos de Salud</h4>
                <div class="form-section-vertical">
                    <div class="form-group">
                      <label>¿Practica algún deporte?</label>
                      <div class="radio-group">
                        <input type="radio" id="edit-practicaDeporte-si" name="edit-practicaDeporte" value="Sí"><label for="edit-practicaDeporte-si">Sí</label>
                        <input type="radio" id="edit-practicaDeporte-no" name="edit-practicaDeporte" value="No"><label for="edit-practicaDeporte-no">No</label>
                      </div>
                    </div>
                    <div class="form-group" id="edit-especifiqueDeporte-container" style="display:none;">
                      <label for="edit-especifiqueDeporte">¿Cuál?</label>
                      <input type="text" id="edit-especifiqueDeporte">
                    </div>

                    <div class="form-group">
                      <label>¿Padece alguna enfermedad?</label>
                      <div class="radio-group">
                        <input type="radio" id="edit-tieneEnfermedad-si" name="edit-tieneEnfermedad" value="Sí"><label for="edit-tieneEnfermedad-si">Sí</label>
                        <input type="radio" id="edit-tieneEnfermedad-no" name="edit-tieneEnfermedad" value="No"><label for="edit-tieneEnfermedad-no">No</label>
                      </div>
                    </div>
                    <div class="form-group" id="edit-especifiqueEnfermedad-container" style="display:none;">
                      <label for="edit-especifiqueEnfermedad">¿Cuál?</label>
                      <input type="text" id="edit-especifiqueEnfermedad">
                    </div>

                    <div class="form-group">
                      <label>¿Es alérgico/a?</label>
                      <div class="radio-group">
                        <input type="radio" id="edit-esAlergico-si" name="edit-esAlergico" value="Sí"><label for="edit-esAlergico-si">Sí</label>
                        <input type="radio" id="edit-esAlergico-no" name="edit-esAlergico" value="No"><label for="edit-esAlergico-no">No</label>
                      </div>
                    </div>
                    <div class="form-group" id="edit-especifiqueAlergia-container" style="display:none;">
                      <label for="edit-especifiqueAlergia">¿A qué?</label>
                      <input type="text" id="edit-especifiqueAlergia">
                    </div>
                </div>

                <hr>
                <h4>Personas Autorizadas a Retirar</h4>
                <div id="edit-autorizados-container"></div>
                <button type="button" id="btn-edit-add-autorizado" class="btn-dinamico" style="width: auto;">+ Agregar Autorizado</button>

                <hr>
                <h4>Certificado de Aptitud</h4>
                <label for="edit-aptitud-upload">Reemplazar Certificado (Opcional)</label>
                <p style="font-size: 0.9em; margin-bottom: 10px;">(Solo seleccione un archivo si desea reemplazar el existente o subir uno nuevo).</p>
                <input type="file" id="edit-aptitud-upload" accept="image/jpeg, image/png, application/pdf">
                <label for="edit-aptitud-upload" class="file-input-label">Seleccionar Nuevo Certificado</label>
                <span id="edit-aptitud-name" class="file-name">Ningún archivo seleccionado</span>
                <div class="loader-archivo" id="loader-edit-aptitud"></div>
                <input type="hidden" id="edit-urlCertificadoAptitud">

                <div class="edit-form-actions">
                  <button type="button" id="btn-guardar-cambios" class="btn-principal">Guardar Cambios</button>
                  <button type="button" id="btn-cancelar-edicion" class="btn-secundario">Cancelar</button>
                </div>
              </div>
            </div>`;



      statusDiv.innerHTML = html;

      const tokenContainer = document.createElement('div');

      tokenContainer.id = 'token-flow-container';

      tokenContainer.style.marginTop = '15px';

      statusDiv.appendChild(tokenContainer);



      // (Listeners)

      if (response.adeudaAptitud === true) {

        document.getElementById('aptitud-manual-upload').addEventListener('change', function () { document.getElementById('aptitud-manual-name').textContent = this.files[0] ? this.files[0].name : 'Ningún archivo seleccionado'; });

        document.getElementById('btn-submit-aptitud-manual').addEventListener('click', submitAptitudManual);

      }



      if (debeMostrarComprobanteSection) {

        const cuotaSelectorContainer = document.getElementById('cuota-selector-container');

        const datosExternoContainer = document.getElementById('datos-externo-container');

        const uploadFileContainer = document.getElementById('upload-file-container');

        const fileInputComprobante = document.getElementById('comprobante-manual-upload');

        const btnClearComprobante = document.getElementById('btn-clear-comprobante');

        const pagoFamiliarContainer = document.getElementById('pago-familiar-container');



        const tipoComprobanteSelect = document.getElementById('tipo-comprobante-select');

        if (tipoComprobanteSelect) {

          tipoComprobanteSelect.addEventListener('change', function () {

            const tipo = this.value;

            datosExternoContainer.style.display = tipo ? 'block' : 'none';

            uploadFileContainer.style.display = tipo ? 'block' : 'none';

            cuotaSelectorContainer.style.display = tipo === 'mp_cuotas_group' ? 'block' : 'none';



            const subMetodoContainer = document.getElementById('sub-metodo-cuotas-comprobante-container');

            if (subMetodoContainer) subMetodoContainer.style.display = tipo === 'mp_cuotas_group' ? 'block' : 'none';



            if (pagoFamiliarContainer) {

              pagoFamiliarContainer.style.display = response.tieneHermanos ? 'flex' : 'none';

            }

            if (fileInputComprobante) fileInputComprobante.value = '';

            if (document.getElementById('comprobante-manual-name')) document.getElementById('comprobante-manual-name').textContent = 'Ningún archivo seleccionado';

            if (btnClearComprobante) btnClearComprobante.style.display = 'none';
          });
        }

        if (fileInputComprobante) {
          fileInputComprobante.addEventListener('change', function () {
            const file = this.files[0];
            document.getElementById('comprobante-manual-name').textContent = file ? file.name : 'Ningún archivo seleccionado';
            btnClearComprobante.style.display = file ? 'inline-block' : 'none';
          });
        }

        if (btnClearComprobante) {
          btnClearComprobante.addEventListener('click', function () {
            fileInputComprobante.value = '';
            document.getElementById('comprobante-manual-name').textContent = 'Ningún archivo seleccionado';
            this.style.display = 'none';
          });
        }


        // =========================================================
        // --- (INICIO DE LA MODIFICACIÓN v19 - LÓGICA DE PARIDAD ESTRICTA) ---
        // =========================================================
        const familiaPagos = response.familiaPagos || {};
        const familiaDnis = Object.keys(familiaPagos);
        const checkboxesCuotas = document.querySelectorAll('.cuota-checkbox-item input[type="checkbox"]');
        const pagoFamiliarCheckbox = document.getElementById('es-pago-familiar-check');

        /**
         * (FUNCIÓN MODIFICADA v19)
         * Habilita el checkbox familiar si:
         * 1. (Pago Único) Se selecciona "Externo" o "mp_total".
         * 2. (Pago en Cuotas) El *estado de deuda* de TODOS los hermanos es
         * IDÉNTICO y se selecciona una cuota que TODOS deben.
         */
        function actualizarEstadoPagoFamiliar() {
          if (!pagoFamiliarCheckbox) return;

          const tipoComprobante = document.getElementById('tipo-comprobante-select').value;
          let habilitar = false;
          let motivoDeshabilitado = "Seleccione un tipo de comprobante.";

          if (familiaDnis.length === 0) {
            motivoDeshabilitado = "No se encontraron otros miembros de la familia.";
          } else if (response.algunoHermanoConComprobantesCompletos) {
            motivoDeshabilitado = "Un miembro de la familia ya completó todos sus pagos.";

          } else if (tipoComprobante === 'externo' || tipoComprobante === 'mp_total') {
            // --- LÓGICA DE PAGO ÚNICO (Transferencia/Efectivo) ---
            // Como solicitaste: "siempre esta habilitada"
            habilitar = true;
            motivoDeshabilitado = "";

          } else if (tipoComprobante === 'mp_cuotas_group') {
            // --- LÓGICA DE PAGO EN CUOTAS (PARIDAD ESTRICTA) ---

            // 1. Verificar si todos los hermanos tienen el MISMO estado de pago.
            let primerEstado = null;
            let paridadDeEstado = true;
            for (const dni of familiaDnis) {
              const estadoSerializado = JSON.stringify(familiaPagos[dni]);
              if (primerEstado === null) {
                primerEstado = estadoSerializado;
              } else if (primerEstado !== estadoSerializado) {
                paridadDeEstado = false;
                break;
              }
            }

            if (!paridadDeEstado) {
              // Si sus estados son diferentes (ej. H1 debe C1, H2 debe C2), deshabilitar.
              habilitar = false;
              motivoDeshabilitado = "El estado de pago de los hermanos no es idéntico. No se puede realizar un pago familiar de cuotas.";
            } else {
              // Si sus estados SÍ son iguales, verificar las cuotas seleccionadas.
              motivoDeshabilitado = "Seleccione una o más cuotas.";
              const cuotasSeleccionadas = Array.from(checkboxesCuotas)
                .filter(cb => cb.checked)
                .map(cb => cb.id.split('-')[2]);

              if (cuotasSeleccionadas.length > 0) {
                // Como todos tienen el mismo estado, solo revisamos al primer hermano
                // para ver si las cuotas seleccionadas están pendientes.
                let cuotasEstanPendientes = true;
                const primerHermano = familiaPagos[familiaDnis[0]];
                for (const cuotaNum of cuotasSeleccionadas) {
                  if (primerHermano['c' + cuotaNum] !== 'pendiente') {
                    cuotasEstanPendientes = false;
                    motivoDeshabilitado = `La cuota ${cuotaNum} no está pendiente para la familia.`;
                    break;
                  }
                }

                if (cuotasEstanPendientes) {
                  habilitar = true;
                  motivoDeshabilitado = "";
                }
              }
            }
          }

          pagoFamiliarCheckbox.disabled = !habilitar;
          if (!habilitar) {
            pagoFamiliarCheckbox.checked = false;
            pagoFamiliarCheckbox.title = `Opción no disponible: ${motivoDeshabilitado}`;
          } else {
            pagoFamiliarCheckbox.title = 'Tilde la opción si el comprobante elegido incluye a los/as (hermanos/as)?';
          }
        }
        // =========================================================
        // --- (FIN DE LA MODIFICACIÓN v19) ---
        // =========================================================


        // (MODIFICADO) El listener del dropdown principal AHORA TAMBIÉN debe llamar a la función.
        if (tipoComprobanteSelect) {
          tipoComprobanteSelect.addEventListener('change', actualizarEstadoPagoFamiliar);
        }

        checkboxesCuotas.forEach(checkbox => {
          checkbox.addEventListener('change', actualizarEstadoPagoFamiliar);
        });

        // Llamada inicial para establecer el estado correcto
        actualizarEstadoPagoFamiliar();

        const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
        if (btnSubmitComprobante) {
          btnSubmitComprobante.addEventListener('click', function () {
            const file = fileInputComprobante.files[0];
            let tipoComprobante = document.getElementById('tipo-comprobante-select').value;
            const loaderComprobante = document.getElementById('loader-comprobante');
            loaderComprobante.style.display = 'none';
            loaderComprobante.innerHTML = `<div class="spinner"></div><p>Subiendo comprobante...</p>`;

            let cuotasSeleccionadas = [];
            if (tipoComprobante === 'mp_cuotas_group') {
              document.querySelectorAll('.cuota-checkbox-item input:checked').forEach(chk => {
                cuotasSeleccionadas.push(chk.value);
              });
              if (cuotasSeleccionadas.length === 0) {
                loaderComprobante.innerHTML = `<div class="mensaje error" style="margin-bottom:0;">Por favor, seleccione al menos una cuota (no pagada) que corresponda al comprobante.</div>`;
                loaderComprobante.style.display = 'block';
                return;
              }
            } else {
              if (!tipoComprobante) {
                loaderComprobante.innerHTML = `<div class="mensaje error" style="margin-bottom:0;">Por favor, seleccione el tipo de comprobante.</div>`;
                loaderComprobante.style.display = 'block';
                return;
              }
              cuotasSeleccionadas.push(tipoComprobante); // Para pagos totales, el array tiene un solo elemento
            }

            const nombrePagador = document.getElementById('externo-nombre-pagador').value;
            const dniPagadorInput = document.getElementById('externo-dni-pagador');
            const dniPagador = dniPagadorInput.value;
            if (!nombrePagador || !dniPagador) {
              loaderComprobante.innerHTML = `<div class="mensaje error" style="margin-bottom:0;">Por favor, complete el Nombre/Apellido y DNI del Adulto Pagador.</div>`;
              loaderComprobante.style.display = 'block';
              return;
            }
            if (!/^[0-9]{8}$/.test(dniPagador)) {
              loaderComprobante.innerHTML = `<div class="mensaje error" style="margin-bottom:0;">Error: El DNI del Adulto Pagador debe tener 8 dígitos numéricos.</div>`;
              loaderComprobante.style.display = 'block';
              dniPagadorInput.focus();
              return;
            }
            const datosExtras = { nombrePagador: nombrePagador, dniPagador: dniPagador };

            if (tipoComprobante === 'mp_cuotas_group') {
              const subMetodos = Array.from(document.querySelectorAll('input[name="subMetodoCuotasComprobante"]:checked')).map(cb => cb.value);
              if (subMetodos.length === 0) {
                loaderComprobante.innerHTML = `<div class="mensaje error" style="margin-bottom:0;">Por favor, indique cómo pagó la cuota.</div>`;
                loaderComprobante.style.display = 'block';
                return;
              }
              datosExtras.subMetodo = subMetodos.join(', ');
            }


            const dni = document.getElementById('dni-input').value;

            const esPagoFamiliar = document.getElementById('es-pago-familiar-check').checked;

            if (!file) {
              loaderComprobante.innerHTML = `<div class="mensaje error" style="margin-bottom:0;">Tenes que adjuntar un comprobante.</div>`;
              loaderComprobante.style.display = 'block';
              return;
            }

            this.disabled = true;
            fileInputComprobante.disabled = true;
            if (document.getElementById('btn-finalizar-upload')) document.getElementById('btn-finalizar-upload').disabled = true;

            const progressContainer = document.getElementById('progress-container-comprobante');
            const progressBar = document.getElementById('progress-bar-comprobante');
            if (progressContainer && progressBar) {
              progressContainer.style.display = 'block';
              progressBar.style.width = '0%';
              progressBar.textContent = '0%';
              progressBar.style.backgroundColor = '#007bff'; // Initial color (blue)

              let progress = 0;
              const interval = setInterval(() => {
                progress += 5;
                if (progress < 95) {
                  progressBar.style.width = progress + '%';
                  progressBar.textContent = progress + '%';
                  // Calculate color: from blue (0%) to green (100%)
                  const blueComponent = Math.floor(255 * (1 - progress / 100));
                  const greenComponent = Math.floor(255 * (progress / 100));
                  const color = `rgb(0, ${greenComponent}, ${blueComponent})`;
                  progressBar.style.backgroundColor = color;
                } else {
                  clearInterval(interval);
                }
              }, 150);

              this.dataset.progressInterval = interval;
            } else {
              loaderComprobante.style.display = 'block';
            }


            comprimirYLeerArchivo(file).then(fileData => {

              google.script.run

                .withSuccessHandler(handleComprobanteUploadSuccess)

                .withFailureHandler(handleComprobanteUploadFailure)

                .subirComprobanteManual(dni, fileData, cuotasSeleccionadas, datosExtras, esPagoFamiliar); // Se envía el array de cuotas

            }).catch(err => {

              handleComprobanteUploadFailure(err);

            });

          });

        }

      }



      const btnFinalizar = document.getElementById('btn-finalizar-upload');

      if (btnFinalizar) {

        btnFinalizar.addEventListener('click', () => { window.top.location.href = APP_URL; });

      }

      document.getElementById('btn-mostrar-editar').addEventListener('click', solicitarTokenParaEditar);
      document.getElementById('btn-cancelar-edicion').addEventListener('click', ocultarFormEdicion);
      document.getElementById('btn-edit-add-autorizado').addEventListener('click', () => addAutorizadoCamposEdicion());
      document.getElementById('edit-aptitud-upload').addEventListener('change', manejarSubidaAptitudEdicion);
      document.getElementById('btn-guardar-cambios').addEventListener('click', submitDatosEditados);
    } else {
      statusDiv.innerHTML = `<div class="mensaje error"><strong>Aviso:</strong> ${response.message}</div>`;
    }
  }

  function handleValidationFailure(error) {
    document.getElementById('btn-validar').disabled = false;
    document.getElementById('loader-validacion').style.display = 'none';
    document.getElementById('status-validacion').innerHTML = `<div class="mensaje error"><strong>Error en el Servidor:</strong> ${error.message}</div>`;
  }

  /**
   * (NUEVO) Inicia el flujo de validación por token al hacer clic en "Editar Datos".
   */
  function solicitarTokenParaEditar() {
    // Limpiar cualquier temporizador anterior
    if (window.tokenTimerInterval) clearInterval(window.tokenTimerInterval);
    const editButton = document.getElementById('btn-mostrar-editar');
    const tokenFlowContainer = document.getElementById('token-flow-container');

    if (!datosEdicionGlobales || !datosEdicionGlobales.dni) {
      tokenFlowContainer.innerHTML = `<div class="mensaje error">Error: No se pudo obtener el DNI para la verificación.</div>`;
      return;
    }
    const dni = datosEdicionGlobales.dni;
    editButton.disabled = true;

    // (NUEVO) Lógica de la barra de progreso
    tokenFlowContainer.innerHTML = `
        <p style="text-align:center; font-weight:bold; margin-top:15px;">Generando código de seguridad...</p>
        <div id="progress-bar-container">
            <div id="progress-bar">0%</div>
        </div>`;

    const progressBar = document.getElementById('progress-bar');
    setTimeout(() => {
      progressBar.style.transition = 'width 1.8s ease-out';
      progressBar.style.width = '100%';
      progressBar.textContent = 'Enviando...';
    }, 100);

    setTimeout(() => {
      google.script.run.withSuccessHandler(onTokenEnviado).withFailureHandler(handleValidationFailure).generarYEnviarToken(dni);
    }, 2000); // Llamada al servidor después de 2 segundos
  }

  /**
   * (NUEVO) Se ejecuta cuando el token se envía correctamente por email.
   * Muestra la sección para ingresar el token.
   */
  function onTokenEnviado(response) {
    const editButton = document.getElementById('btn-mostrar-editar');
    const tokenFlowContainer = document.getElementById('token-flow-container');
    editButton.disabled = false;

    if (response.status === 'OK') {
      // (CORRECCIÓN DEFINITIVA) Clonar el nodo en lugar de moverlo.
      // Esto asegura que el #token-seccion original nunca se pierda del DOM.
      const tokenSeccionOriginal = document.getElementById('token-seccion');
      const tokenSeccionClone = tokenSeccionOriginal.cloneNode(true);

      // Asignar un ID único al clon para que los selectores funcionen
      tokenSeccionClone.id = 'token-seccion-clonada';

      tokenFlowContainer.innerHTML = ''; // Limpiar el loader
      tokenFlowContainer.appendChild(tokenSeccionClone);
      tokenSeccionClone.style.display = 'block';
      tokenSeccionClone.querySelector('#status-token-envio').innerHTML = `<div class="mensaje exito">${response.message}</div>`;

      // Lógica de eventos para el CLON
      const tokenInputs = tokenSeccionClone.querySelectorAll('.token-input');
      tokenInputs.forEach((input, index) => {
        input.addEventListener('keyup', (e) => {
          if (e.key >= 0 && e.key <= 9 && index < tokenInputs.length - 1) {
            tokenInputs[index + 1].focus();
          } else if (e.key === 'Backspace' && index > 0) {
            tokenInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          const pasteData = (e.clipboardData || window.clipboardData).getData('text').trim();
          if (/^\d{6}$/.test(pasteData)) {
            e.preventDefault();
            pasteData.split('').forEach((char, i) => {
              if (i < tokenInputs.length) { tokenInputs[i].value = char; }
            });
            tokenSeccionClone.querySelector('#btn-validar-token').focus();
          }
        });
      });

      tokenSeccionClone.querySelector('#btn-validar-token').addEventListener('click', function () {
        let token = '';
        tokenInputs.forEach(input => token += input.value);

        if (token.length !== 6) {
          tokenSeccionClone.querySelector('#status-token-validacion').innerHTML = `<div class="mensaje error">Por favor, ingrese los 6 dígitos del código.</div>`;
          return;
        }

        const dni = document.getElementById('dni-input').value;
        this.disabled = true;
        tokenSeccionClone.querySelector('#loader-token').style.display = 'block';
        tokenSeccionClone.querySelector('#status-token-validacion').innerHTML = '';

        google.script.run
          .withSuccessHandler(onTokenValidado)
          .withFailureHandler(handleValidationFailure)
          .validarToken(dni, token);
      });

      // (NUEVO) Listener para el botón "Volver"
      tokenSeccionClone.querySelector('#btn-volver-validacion').addEventListener('click', function () {
        tokenFlowContainer.innerHTML = ''; // Limpiar la sección del token
        if (window.tokenTimerInterval) clearInterval(window.tokenTimerInterval);
      });

      iniciarTemporizadorToken();
      tokenSeccionClone.querySelector('.token-input').focus();
    } else {
      tokenFlowContainer.innerHTML = `<div class="mensaje error">${response.message}</div>`;
    }
  }

  /**
   * (NUEVO) Se ejecuta cuando el token ingresado es validado.
   * Si es correcto, muestra el formulario de edición.
   */
  function onTokenValidado(response) {
    const tokenClone = document.getElementById('token-seccion-clonada');
    if (tokenClone) {
      tokenClone.querySelector('#loader-token').style.display = 'none';
      tokenClone.querySelector('#btn-validar-token').disabled = false;
    }

    if (response.status === 'OK') {
      // Ocultar la sección del token y mostrar el formulario de edición
      if (window.tokenTimerInterval) {
        clearInterval(window.tokenTimerInterval);
      }

      // Ocultar el contenedor de flujo de token
      document.getElementById('token-flow-container').innerHTML = '';

      mostrarFormEdicion(); // Llama a la función que prepara y muestra el form de edición
    } else {
      if (tokenClone) {
        tokenClone.querySelector('#status-token-validacion').innerHTML = `<div class="mensaje error">${response.message}</div>`;
        tokenClone.querySelectorAll('.token-input').forEach(input => input.value = '');
        tokenClone.querySelector('.token-input').focus();
      }
    }
  }

  function mostrarFormEdicion() {
    iniciarTemporizadorEdicion();

    if (!datosEdicionGlobales) {
      alert('Error: No se cargaron los datos para editar.');
      return;
    }

    // --- Populate basic fields ---
    document.getElementById('edit-dni').value = datosEdicionGlobales.dni || '';
    document.getElementById('edit-email').value = datosEdicionGlobales.email || '';
    document.getElementById('edit-adultoResponsable1').value = datosEdicionGlobales.adultoResponsable1 || '';
    document.getElementById('edit-dniResponsable1').value = datosEdicionGlobales.dniResponsable1 || '';
    document.getElementById('edit-adultoResponsable2').value = datosEdicionGlobales.adultoResponsable2 || '';
    document.getElementById('edit-dniResponsable2').value = datosEdicionGlobales.dniResponsable2 || '';

    // --- Populate and parse telephone numbers ---
    const telMatch1 = String(datosEdicionGlobales.telResponsable1 || '').match(/\(?(\d{2,5})\)?\s?(\d+)/);
    if (telMatch1) {
      document.getElementById('edit-telAreaResp1').value = telMatch1[1] || '';
      document.getElementById('edit-telNumResp1').value = telMatch1[2] || '';
    } else {
      document.getElementById('edit-telAreaResp1').value = '';
      document.getElementById('edit-telNumResp1').value = '';
    }
    const telMatch2 = String(datosEdicionGlobales.telResp2 || '').match(/\(?(\d{2,5})\)?\s?(\d+)/);
    if (telMatch2) {
      document.getElementById('edit-telAreaResp2').value = telMatch2[1] || '';
      document.getElementById('edit-telNumResp2').value = telMatch2[2] || '';
    } else {
      document.getElementById('edit-telAreaResp2').value = '';
      document.getElementById('edit-telNumResp2').value = '';
    }

    // --- Populate health fields ---
    function setRadioValue(name, value) {
      const radioSi = document.querySelector(`input[name="${name}"][value="Sí"]`);
      const radioNo = document.querySelector(`input[name="${name}"][value="No"]`);

      if (radioSi && radioNo) {
        const normalizedValue = value ? value.trim().toLowerCase() : '';
        if (normalizedValue === 'sí' || normalizedValue === 'si') {
          radioSi.checked = true;
          radioNo.checked = false;
        } else if (normalizedValue === 'no') {
          radioSi.checked = false;
          radioNo.checked = true;
        } else {
          radioSi.checked = false;
          radioNo.checked = false;
        }
      }
    }

    setRadioValue('edit-practicaDeporte', datosEdicionGlobales.practicaDeporte);
    document.getElementById('edit-especifiqueDeporte').value = datosEdicionGlobales.especifiqueDeporte || '';
    toggleEditEspecifique('edit-practicaDeporte', 'edit-especifiqueDeporte-container');

    setRadioValue('edit-tieneEnfermedad', datosEdicionGlobales.tieneEnfermedad);
    document.getElementById('edit-especifiqueEnfermedad').value = datosEdicionGlobales.especifiqueEnfermedad || '';
    toggleEditEspecifique('edit-tieneEnfermedad', 'edit-especifiqueEnfermedad-container');

    setRadioValue('edit-esAlergico', datosEdicionGlobales.esAlergico);
    document.getElementById('edit-especifiqueAlergia').value = datosEdicionGlobales.especifiqueAlergia || '';
    toggleEditEspecifique('edit-esAlergico', 'edit-especifiqueAlergia-container');

    // Add event listeners for health radio buttons
    document.querySelectorAll('input[name="edit-practicaDeporte"]').forEach(el => el.addEventListener('change', () => toggleEditEspecifique('edit-practicaDeporte', 'edit-especifiqueDeporte-container')));
    document.querySelectorAll('input[name="edit-tieneEnfermedad"]').forEach(el => el.addEventListener('change', () => toggleEditEspecifique('edit-tieneEnfermedad', 'edit-especifiqueEnfermedad-container')));
    document.querySelectorAll('input[name="edit-esAlergico"]').forEach(el => el.addEventListener('change', () => toggleEditEspecifique('edit-esAlergico', 'edit-especifiqueAlergia-container')));


    // --- Populate authorized people ---
    const container = document.getElementById('edit-autorizados-container');
    container.innerHTML = '';
    if (datosEdicionGlobales.personasAutorizadas) {
      const autorizados = datosEdicionGlobales.personasAutorizadas.split(',');
      autorizados.forEach(aut => {
        const autTrim = aut.trim();
        if (autTrim) {
          const match = autTrim.match(/(.*)\(DNI:\s?(\d+)\)/);
          if (match) {
            addAutorizadoCamposEdicion(match[1].trim(), match[2].trim());
          } else {
            addAutorizadoCamposEdicion(autTrim, '');
          }
        }
      });
    }
    if (container.children.length === 0) {
      addAutorizadoCamposEdicion();
    }

    // --- Reset file inputs ---
    document.getElementById('edit-aptitud-upload').value = '';
    document.getElementById('edit-aptitud-name').textContent = 'Ningún archivo seleccionado';
    document.getElementById('edit-urlCertificadoAptitud').value = '';
    document.getElementById('loader-edit-aptitud').style.display = 'none';

    // --- Show form ---
    document.getElementById('editar-form-container').style.display = 'block';
    document.getElementById('btn-mostrar-editar').style.display = 'none';
  }

  function toggleEditEspecifique(radioName, containerId) {
    const container = document.getElementById(containerId);
    const radioSi = document.querySelector(`input[name="${radioName}"][value="Sí"]`);
    if (container && radioSi) {
      container.style.display = radioSi.checked ? 'block' : 'none';
    }
  }

  function ocultarFormEdicion() {
    // (NUEVO) Detener el temporizador de edición si el usuario cancela
    if (window.editTimerInterval) clearInterval(window.editTimerInterval);

    document.getElementById('editar-form-container').style.display = 'none';
    document.getElementById('btn-mostrar-editar').style.display = 'block';
    document.getElementById('edit-aptitud-upload').value = '';
    document.getElementById('edit-aptitud-name').textContent = 'Ningún archivo seleccionado';
    document.getElementById('edit-urlCertificadoAptitud').value = '';
  }

  /**
   * (CORRECCIÓN) Se restaura la función del temporizador del token.
   */
  function iniciarTemporizadorToken() {
    let duracion = 120; // 2 minutos en segundos
    const timerDisplay = document.querySelector('#token-seccion-clonada #token-timer');
    if (!timerDisplay) return;

    if (window.tokenTimerInterval) clearInterval(window.tokenTimerInterval);

    window.tokenTimerInterval = setInterval(function () {
      const minutos = parseInt(duracion / 60, 10);
      const segundos = parseInt(duracion % 60, 10);

      const minutosStr = minutos < 10 ? "0" + minutos : minutos;
      const segundosStr = segundos < 10 ? "0" + segundos : segundos;

      timerDisplay.textContent = `Tiempo restante: ${minutosStr}:${segundosStr}`;

      if (--duracion < 0) {
        clearInterval(window.tokenTimerInterval);
        // (NUEVO) Mostrar modal personalizado en lugar de alert
        mostrarModalExpirado("El tiempo para ingresar el código ha expirado. El formulario se reiniciará.");
      }
    }, 1000);
  }


  function manejarSubidaAptitudEdicion() {
    const inputElement = document.getElementById('edit-aptitud-upload');
    const file = inputElement.files[0];
    const nombreLabel = document.getElementById('edit-aptitud-name');
    const loader = document.getElementById('loader-edit-aptitud');
    const urlHidden = document.getElementById('edit-urlCertificadoAptitud');
    const dni = document.getElementById('edit-dni').value;

    urlHidden.value = '';
    loader.style.display = 'none';
    nombreLabel.textContent = 'Ningún archivo seleccionado';
    if (!file) return;

    nombreLabel.textContent = file.name;
    loader.className = 'loader-archivo';
    loader.style.display = 'block';
    loader.textContent = 'Preparando archivo...';

    inputElement.disabled = true;
    document.getElementById('btn-guardar-cambios').disabled = true;

    comprimirYLeerArchivo(file).then(fileData => { // Llama a js2.html
      loader.textContent = 'Subiendo archivo...';
      google.script.run
        .withSuccessHandler(function (response) {
          inputElement.disabled = false;
          document.getElementById('btn-guardar-cambios').disabled = false;
          if (response.status === 'OK') {
            loader.className = 'loader-archivo exito';
            loader.textContent = '✅ Nuevo certificado subido. Pulse "Guardar Cambios".';
            urlHidden.value = response.url; // <-- Guarda la URL simple
          } else {
            loader.className = 'loader-archivo error';
            loader.textContent = `❌ Error:   ${response.message}`;
            inputElement.value = '';
            nombreLabel.textContent = 'Ningún archivo seleccionado';
          }
        })
        .withFailureHandler(function (error) {
          inputElement.disabled = false;
          document.getElementById('btn-guardar-cambios').disabled = false;
          loader.className = 'loader-archivo error';
          loader.textContent = `❌ Error de conexión:   ${error.message}`;
          inputElement.value = '';
          nombreLabel.textContent = 'Ningún archivo seleccionado';
        })
        .subirArchivoIndividual(fileData, dni, 'ficha');
    }).catch(err => {
      inputElement.disabled = false;
      document.getElementById('btn-guardar-cambios').disabled = false;
      loader.className = 'loader-archivo error';
      loader.textContent = `❌ Error al procesar:   ${err.message}`;
      inputElement.value = '';
      nombreLabel.textContent = 'Ningún archivo seleccionado';
    });
  }

  function submitDatosEditados() {
    if (window.editTimerInterval) clearInterval(window.editTimerInterval);

    const dni = document.getElementById('edit-dni').value;

    // --- Combine telephone numbers ---
    const telArea1 = document.getElementById('edit-telAreaResp1').value;
    const telNum1 = document.getElementById('edit-telNumResp1').value;
    const telResp1 = telArea1 && telNum1 ? `(${telArea1}) ${telNum1}` : '';

    const telArea2 = document.getElementById('edit-telAreaResp2').value;
    const telNum2 = document.getElementById('edit-telNumResp2').value;
    const telResp2 = telArea2 && telNum2 ? `(${telArea2}) ${telNum2}` : '';

    // --- Helper to get radio value ---
    function getRadioValue(name) {
      const radio = document.querySelector(`input[name="${name}"]:checked`);
      return radio ? radio.value : '';
    }

    const datosEditados = {
      adultoResponsable1: document.getElementById('edit-adultoResponsable1').value,
      dniResponsable1: document.getElementById('edit-dniResponsable1').value,
      telResp1: telResp1,
      adultoResponsable2: document.getElementById('edit-adultoResponsable2').value,
      dniResponsable2: document.getElementById('edit-dniResponsable2').value,
      telResp2: telResp2,
      urlCertificadoAptitud: document.getElementById('edit-urlCertificadoAptitud').value,
      // --- Add health data ---
      practicaDeporte: getRadioValue('edit-practicaDeporte'),
      especifiqueDeporte: document.getElementById('edit-especifiqueDeporte').value,
      tieneEnfermedad: getRadioValue('edit-tieneEnfermedad'),
      especifiqueEnfermedad: document.getElementById('edit-especifiqueEnfermedad').value,
      esAlergico: getRadioValue('edit-esAlergico'),
      especifiqueAlergia: document.getElementById('edit-especifiqueAlergia').value
    };

    // --- Validations ---
    if (datosEditados.dniResponsable1 && !/^[0-9]{8}$/.test(datosEditados.dniResponsable1)) {
      alert('Error: El DNI del Responsable 1 debe tener 8 dígitos numéricos.');
      document.getElementById('edit-dniResponsable1').focus();
      return;
    }
    if (datosEditados.dniResponsable2 && !/^[0-9]{8}$/.test(datosEditados.dniResponsable2)) {
      alert('Error: El DNI del Responsable 2 debe tener 8 dígitos numéricos.');
      document.getElementById('edit-dniResponsable2').focus();
      return;
    }
    if (telArea1 && !/^[1-9][0-9]{1,4}$/.test(telArea1)) {
      alert('Error: El Código de Área del Responsable 1 es inválido.');
      document.getElementById('edit-telAreaResp1').focus();
      return;
    }
    if (telNum1 && !/^[0-9]{6,10}$/.test(telNum1)) {
      alert('Error: El Número de teléfono del Responsable 1 es inválido.');
      document.getElementById('edit-telNumResp1').focus();
      return;
    }

    const nombresAut = document.querySelectorAll('.edit-autorizado-nombre');
    const dnisAut = document.querySelectorAll('.edit-autorizado-dni');
    let autorizadosValidos = 0;
    let autorizadosArray = [];

    for (let i = 0; i < nombresAut.length; i++) {
      const nombre = nombresAut[i].value.trim();
      const dniAut = dnisAut[i] ? dnisAut[i].value.trim() : '';

      if (nombre && dniAut) {
        if (!/^[0-9]{8}$/.test(dniAut)) {
          alert('Error: El DNI de la persona autorizada (' + nombre + ') debe tener exactamente 8 dígitos numéricos.');
          dnisAut[i].focus();
          return;
        }
        autorizadosArray.push(`${nombre} (DNI: ${dniAut})`);
        autorizadosValidos++;
      } else if (nombre && !dniAut) {
        alert('Error: Por favor complete el DNI de la persona autorizada (' + nombre + ').');
        dnisAut[i].focus();
        return;
      } else if (!nombre && dniAut) {
        alert('Error: Por favor complete el Nombre de la persona autorizada con DNI ' + dniAut + '.');
        nombresAut[i].focus();
        return;
      }
    }

    if (autorizadosValidos === 0) {
      alert('Error: Debe ingresar al menos una persona autorizada (Nombre y DNI).');
      return;
    }
    datosEditados.personasAutorizadas = autorizadosArray.join(', ');

    document.getElementById('btn-guardar-cambios').disabled = true;
    document.getElementById('btn-cancelar-edicion').disabled = true;
    const loader = document.getElementById('loader-validacion');
    const statusDiv = document.getElementById('status-validacion');
    loader.style.display = 'block';
    loader.querySelector('p').textContent = "Guardando cambios...";

    google.script.run
      .withSuccessHandler(function (response) {
        loader.style.display = 'none';
        document.getElementById('btn-guardar-cambios').disabled = false;
        document.getElementById('btn-cancelar-edicion').disabled = false;
        const statusDiv = document.getElementById('status-validacion');

        if (response.status === 'OK') {
          limpiarCache();

          // Clear the status div and show success message
          statusDiv.innerHTML = '<div class="mensaje exito">Datos guardados correctamente.</div>';

          // After a short delay, redirect to the clean validation form
          setTimeout(() => {
            window.top.location.href = APP_URL;
          }, 2000); // 2-second delay to allow the user to read the message
        } else {
          statusDiv.innerHTML = `<div class="mensaje error" style="margin-bottom:10px;">Error al guardar: ${response.message}</div>`;
        }
      })
      .withFailureHandler(function (error) {
        loader.style.display = 'none';
        document.getElementById('btn-guardar-cambios').disabled = false;
        document.getElementById('btn-cancelar-edicion').disabled = false;
        statusDiv.innerHTML = `<div class="mensaje error" style="margin-bottom:10px;">Error de conexión: ${error.message}</div>`;
      })
      .actualizarDatosPersonales(dni, datosEditados);
  }

  /**
   * (NUEVO) Inicia y muestra el temporizador de 2 minutos para la edición.
   */
  function iniciarTemporizadorEdicion() {
    let duracion = 180; // 3 minutos en segundos
    const timerDisplay = document.getElementById('edit-timer'); // (CORRECCIÓN) Usar getElementById que es más directo.
    if (!timerDisplay) return;

    // Los estilos ahora se controlan por CSS. Solo nos aseguramos de que sea visible.
    timerDisplay.style.display = 'block';

    if (window.editTimerInterval) clearInterval(window.editTimerInterval);

    window.editTimerInterval = setInterval(function () {
      const minutos = parseInt(duracion / 60, 10);
      const segundos = parseInt(duracion % 60, 10);

      const minutosStr = minutos < 10 ? "0" + minutos : minutos;
      const segundosStr = segundos < 10 ? "0" + segundos : segundos;

      timerDisplay.textContent = `(Tiempo restante: ${minutosStr}:${segundosStr})`;

      if (--duracion < 0) {
        clearInterval(window.editTimerInterval);
        // (NUEVO) Mostrar modal personalizado en lugar de alert
        mostrarModalExpirado("Se agotó el tiempo para editar el formulario. Vuelva a intentar nuevamente.");
      }
    }, 1000);
  }

  function submitAptitudManual() {
    const fileInput = document.getElementById('aptitud-manual-upload');
    const file = fileInput.files[0];
    const dni = document.getElementById('dni-input').value;
    const loader = document.getElementById('loader-aptitud');

    if (!file) {
      loader.innerHTML = `<div class="mensaje error" style="margin-bottom:0; background-color: #f8d7da; color: #721c24;">Tenes que adjuntar un certificado.</div>`;
      loader.style.display = 'block';
      return;
    }

    const btn = document.getElementById('btn-submit-aptitud-manual');
    btn.disabled = true;
    loader.innerHTML = `<div class="spinner"></div><p>Subiendo...</p>`;
    loader.style.display = 'block';

    comprimirYLeerArchivo(file).then(fileData => { // Llama a js2.html
      google.script.run
        .withSuccessHandler(function (response) {
          loader.style.display = 'none';
          if (response.status === 'OK') {

            // =========================================================
            // --- ¡INICIO DE LA MODIFICACIÓN (RE-VALIDACIÓN)! ---
            // =========================================================
            // En lugar de solo mostrar un mensaje, forzamos una
            // re-validación para que handleValidationSuccess
            // pueda verificar si el formulario está 100% completo.

            const statusDiv = document.getElementById('status-validacion');
            // Limpiar mensajes antiguos (excepto el de aptitud que se va a recargar)
            statusDiv.querySelectorAll('.mensaje').forEach(el => {
              if (el.closest && !el.closest('#aptitud-manual-seccion')) {
                el.remove();
              } else if (!el.closest) {
                el.remove();
              }
            });

            statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje exito" style="margin-bottom:10px;">${response.message}</div>`);

            // Disparar la re-validación
            const dni = document.getElementById('dni-input').value;
            document.getElementById('loader-validacion').style.display = 'block';
            document.getElementById('loader-validacion').querySelector('p').textContent = 'Actualizando estado...';

            google.script.run
              .withSuccessHandler(handleValidationSuccess) // Llama al handler principal
              .withFailureHandler(handleValidationFailure)
              .validarAcceso(dni);
            // =========================================================
            // --- FIN DE LA MODIFICACIÓN ---
            // =========================================================

          } else {
            alert("Error al subir: " + response.message);
            btn.disabled = false;
          }
        })
        .withFailureHandler(function (error) {
          loader.style.display = 'none';
          // =========================================================
          // --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
          // Se eliminó la 'D' que causaba el error de sintaxis.
          // =========================================================
          alert("Error de conexión: " + error.message);
          // =========================================================
          // --- FIN DE LA CORRECCIÓN ---
          // =========================================================
          btn.disabled = false;
        })
        .subirAptitudManual(dni, fileData);
    }).catch(err => {
      loader.style.display = 'none';
      alert("Error al procesar archivo: " + err.message);
      btn.disabled = false;
    });
  }

  /**
   * (MODIFICADO)
   * - Asegura que la barra de progreso se oculte en caso de fallo.
   */
  function handleComprobanteUploadFailure(error) {
    const statusDiv = document.getElementById('status-validacion');
    const fileInputComprobante = document.getElementById('comprobante-manual-upload');
    const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
    const btnFinalizar = document.getElementById('btn-finalizar-upload');
    const loaderComprobante = document.getElementById('loader-comprobante');

    // Clear progress interval and hide progress bar
    const submitButton = document.getElementById('btn-submit-comprobante-manual');
    if (submitButton && submitButton.dataset.progressInterval) {
      clearInterval(parseInt(submitButton.dataset.progressInterval));
      const progressContainer = document.getElementById('progress-container-comprobante');
      if (progressContainer) progressContainer.style.display = 'none';
    }
    loaderComprobante.style.display = 'none'; // Ensure spinner is hidden

    statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje error" style="margin-bottom:10px;">Error al subir: ${error.message}</div>`);

    if (btnSubmitComprobante) btnSubmitComprobante.disabled = false;
    if (fileInputComprobante) fileInputComprobante.disabled = false;
    if (btnFinalizar) btnFinalizar.disabled = false;
  }

  /**
   * (MODIFICADO)
   * - Corrige el bug que borraba la sección de aptitud.
   * - Resetea los checkboxes de cuotas al subir exitosamente.
   * - (BUG 1 y 2) FUERZA UNA RE-VALIDACIÓN para ocultar el contenedor si el pago fue completado.
   * (NUEVO)
   * - Elimina la redirección automática.
   * - Muestra mensaje de éxito y permite al usuario finalizar manualmente.
   * - Oculta la barra de progreso.
   */
  function handleComprobanteUploadSuccess(response) {
    const statusDiv = document.getElementById('status-validacion');
    const fileInputComprobante = document.getElementById('comprobante-manual-upload');
    const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
    const btnFinalizar = document.getElementById('btn-finalizar-upload');
    const loaderComprobante = document.getElementById('loader-comprobante');

    const submitButton = document.getElementById('btn-submit-comprobante-manual');
    if (submitButton && submitButton.dataset.progressInterval) {
      clearInterval(parseInt(submitButton.dataset.progressInterval));
    }

    const progressContainer = document.getElementById('progress-container-comprobante');
    const progressBar = document.getElementById('progress-bar-comprobante');

    if (progressBar) {
      progressBar.style.width = '100%';
      progressBar.textContent = '100%';
      progressBar.style.backgroundColor = '#28a745'; // Green for success
    }

    if (progressContainer) {
      setTimeout(() => {
        progressContainer.style.display = 'none';
      }, 500); // Wait half a second before hiding
    }

    loaderComprobante.style.display = 'none'; // Ensure spinner is hidden
    statusDiv.querySelectorAll('.mensaje').forEach(el => {
      // No borrar el mensaje de 'adeuda aptitud'
      if (el.closest && !el.closest('#aptitud-manual-seccion')) {
        el.remove();
      } else if (!el.closest) {
        el.remove();
      }
    });

    if (response.status === 'OK') {
      // --- INICIO DE LA MODIFICACIÓN (ASYNC OCR) ---
      // Mostrar mensaje de éxito inmediato
      statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje exito" style="margin-bottom:10px;">${response.message}</div>`);

      // Si el servidor nos devuelve datos para OCR, lanzamos el proceso en segundo plano
      if (response.fileId) {
        console.log("Iniciando OCR asíncrono...");
        // Mostrar un indicador visual discreto de que se está analizando
        const loaderValidacion = document.getElementById('loader-validacion');
        if (loaderValidacion) {
          loaderValidacion.style.display = 'block';
          loaderValidacion.querySelector('p').textContent = 'Analizando comprobante con IA... (Puede cerrar esta ventana)';
        }

        // Llamada asíncrona al OCR
        google.script.run
          .withSuccessHandler(function (resOCR) {
            console.log("OCR Finalizado:", resOCR);
            // Una vez terminado el OCR, refrescamos la validación para mostrar los colores
            const dni = document.getElementById('dni-input').value;
            google.script.run
              .withSuccessHandler(handleValidationSuccess)
              .withFailureHandler(handleValidationFailure)
              .validarAcceso(dni);
          })
          .withFailureHandler(function (err) {
            console.error("Error en OCR Async:", err);
            // Incluso si falla el OCR, refrescamos para mostrar el error en la celda (amarillo)
            const dni = document.getElementById('dni-input').value;
            google.script.run.withSuccessHandler(handleValidationSuccess).validarAcceso(dni);
          })
          .procesarOCRAsync(response.fileId, response.fila, response.precioEsperado, response.esFamiliar, response.filasFamiliares);
      } else {
        // Si no hay OCR (ej. no se requería), refrescamos directo
        setTimeout(() => {
          const dni = document.getElementById('dni-input').value;
          google.script.run
            .withSuccessHandler(handleValidationSuccess)
            .withFailureHandler(handleValidationFailure)
            .validarAcceso(dni);
        }, 2000);
      }

      // Ocultar la sección de subida de comprobante
      const comprobanteSection = document.getElementById('comprobante-manual-seccion');
      if (comprobanteSection) {
        comprobanteSection.style.display = 'none';
      }
      // --- FIN DE LA MODIFICACIÓN ---

    } else { // Si response.status es 'ERROR'
      statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje error" style="margin-bottom:10px;">${response.message}</div>`);
      if (btnSubmitComprobante) btnSubmitComprobante.disabled = false;
      if (fileInputComprobante) fileInputComprobante.disabled = false;
      if (btnFinalizar) btnFinalizar.disabled = false;
    }
  }

  // =========================================================
  // --- LÓGICA DE INICIO Y ORQUESTACIÓN ---
  // =========================================================

  /**
   * Inicia el temporizador para mostrar el formulario.
   */
  function iniciarTemporizador(response) {
    document.getElementById('timer-seccion').style.display = 'block';
    document.getElementById('btn-validar').disabled = true;
    let segundos = 5;
    const countdown = document.getElementById('timer-countdown');
    countdown.textContent = segundos;
    const interval = setInterval(() => {
      segundos--;
      countdown.textContent = segundos;
      if (segundos <= 0) {
        clearInterval(interval);
        mostrarFormulario(response);
      }
    }, 1000);
  }

  /**
   * Muestra el formulario principal y lo puebla con datos.
   * (MODIFICADO) Añade lógica para deshabilitar cuotas en Pre-Venta
   * (MODIFICADO v2) Añade lógica para setear el hidden input 'esPreventa'.
   */
  function mostrarFormulario(response) {
    document.getElementById('validacion-seccion').style.display = 'none';
    document.getElementById('registro-seccion').style.display = 'block';

    const esPreventa = response.datos && response.datos.esPreventa === true;

    // =========================================================
    // --- (INICIO DE LA CORRECCIÓN) ---
    // Guardar el estado de 'esPreventa' en el campo oculto
    document.getElementById('esPreventa').value = esPreventa;
    // --- (FIN DE LA CORRECCIÓN) ---


    document.getElementById('dni').value = response.datos.dni;

    if (response.datos) {
      document.getElementById('email').value = response.datos.email || '';
      document.getElementById('nombre').value = response.datos.nombre || '';
      document.getElementById('apellido').value = response.datos.apellido || '';
      document.getElementById('fechaNacimiento').value = response.datos.fechaNacimiento || '';
      document.getElementById('obraSocial').value = response.datos.obraSocial || '';
      document.getElementById('colegioJardin').value = response.datos.colegioJardin || '';
      document.getElementById('adultoResponsable1').value = response.datos.adultoResponsable1 || '';
      document.getElementById('dniResponsable1').value = response.datos.dniResponsable1 || '';

      if (response.datos.telResponsable1) {
        const telMatch = String(response.datos.telResponsable1).match(/\(?(\d{2,5})\)?\s?(\d+)/);
        if (telMatch) {
          document.getElementById('telAreaResp1').value = telMatch[1] || '';
          document.getElementById('telNumResp1').value = telMatch[2] || '';
        }
      }

      document.getElementById('adultoResponsable2').value = response.datos.adultoResponsable2 || '';
      document.getElementById('dniResponsable2').value = response.datos.dniResponsable2 || '';
      if (response.datos.telResponsable2) {
        const telMatch2 = String(response.datos.telResponsable2).match(/\(?(\d{2,5})\)?\s?(\d+)/);
        if (telMatch2) {
          document.getElementById('telAreaResp2').value = telMatch2[1] || '';
          document.getElementById('telNumResp2').value = telMatch2[2] || '';
        }
      }

      if (response.datos.personasAutorizadas) {
        const autorizados = response.datos.personasAutorizadas.split(',');
        const container = document.getElementById('autorizados-container');
        container.innerHTML = '';
        autorizados.forEach(aut => {
          const autTrim = aut.trim();
          if (autTrim) {
            const match = autTrim.match(/(.*)\(DNI:\s?(\d+)\)/);
            if (match) addAutorizadoCampos(match[1].trim(), match[2].trim());
            else addAutorizadoCampos(autTrim, '');
          }
        });
      }
    }

    if (response.jornadaExtendidaAlcanzada === true) {
      const opcionExtendida = document.getElementById('opcion-jornada-extendida');
      if (opcionExtendida) {
        opcionExtendida.disabled = true;
        opcionExtendida.textContent = "Jornada Extendida (SIN CUPO)";
      }
      if (document.getElementById('jornada-cupo-msg')) {
        document.getElementById('jornada-cupo-msg').style.display = 'inline';
      }
    }

    const opcionPagoTotal = document.querySelector('#metodoPago option[value="Pago 1 Cuota Deb/Cred MP(Total)"]');
    if (opcionPagoTotal) {
      opcionPagoTotal.style.display = 'none';
      opcionPagoTotal.disabled = true;
    }

    // =========================================================
    // --- (LÓGICA PRE-VENTA) ---
    // =========================================================
    if (esPreventa) {
      // 1. Deshabilitar la opción en el <select>
      const opcionCuotas = document.querySelector('#metodoPago option[value="Pago en Cuotas"]');
      if (opcionCuotas) {
        opcionCuotas.disabled = true;
        opcionCuotas.textContent = "Pago en 3 Cuotas (No disponible para Pre-Venta)";
      }
      // 2. Limpiar el valor por si estaba cacheado
      document.getElementById('metodoPago').value = '';

      // 3. Bloquear campos de Pre-Venta (código que ya tenías)
      ['nombre', 'apellido', 'fechaNacimiento', 'email'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.readOnly = true;
          el.classList.add('campo-bloqueado', 'form-cache');
        }
      });
      if (document.getElementById('jornada')) document.getElementById('jornada').classList.add('form-cache');
      document.getElementById('dni').classList.add('campo-bloqueado', 'form-cache');

      // 4. Setear jornada (código que ya tenías)
      document.getElementById('jornada').value = response.datos.jornada || '';

    } else {
      // (NUEVO) Asegurarse de que si NO es Pre-Venta, la opción esté habilitada
      const opcionCuotas = document.querySelector('#metodoPago option[value="Pago en Cuotas"]');
      if (opcionCuotas) {
        opcionCuotas.disabled = false;
        opcionCuotas.textContent = "Pago en 3 Cuotas";
      }
    }
    // =========================================================
    // --- (FIN LÓGICA PRE-VENTA) ---
    // =========================================================


    if (document.querySelectorAll('.autorizado-nombre').length === 0) addAutorizadoCampos();

    // guardarFormEnCache();
    calcularYMostrarEdad();
    toggleEspecifique('practicaDeporte', 'especifiqueDeporte');
    toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad');
    toggleEspecifique('esAlergico', 'especifiqueAlergia');
    toggleTransferenciaInfo();
    toggleCuotasInfo();
    toggleSubMetodoCuotas(); // (Llamada para el sub-método)
  }

  function manejarSubidaArchivo(inputElement, tipoArchivo, nombreLabelId, loaderId, urlHiddenId, progressContainerId, progressBarId) {
    const file = inputElement.files[0];
    const nombreLabel = document.getElementById(nombreLabelId);
    const loader = document.getElementById(loaderId);
    const urlHidden = document.getElementById(urlHiddenId);
    const dni = document.getElementById('dni').value;

    // Progress bar elements
    const progressContainer = progressContainerId ? document.getElementById(progressContainerId) : null;
    const progressBar = progressBarId ? document.getElementById(progressBarId) : null;

    urlHidden.value = '';
    if (loader) loader.style.display = 'none';
    if (progressContainer) progressContainer.style.display = 'none';
    nombreLabel.textContent = 'Ningún archivo seleccionado';
    if (!file) return;

    if (!dni) {
      alert("Error: No se puede subir un archivo si el DNI no está cargado en el formulario (Paso 2).");
      inputElement.value = '';
      return;
    }

    nombreLabel.textContent = file.name;
    inputElement.disabled = true;
    document.getElementById('submit-button').disabled = true;

    let progressInterval;

    if (progressContainer && progressBar) {
      loader.style.display = 'none';
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      progressBar.style.backgroundColor = '#007bff';

      let progress = 0;
      progressInterval = setInterval(() => {
        progress += 5;
        if (progress < 95) {
          progressBar.style.width = progress + '%';
          progressBar.textContent = progress + '%';
        } else {
          clearInterval(progressInterval);
        }
      }, 150);
    } else {
      loader.className = 'loader-archivo';
      loader.style.display = 'block';
      loader.textContent = 'Iniciando...';
    }

    comprimirYLeerArchivo(file).then(fileData => {
      if (!progressContainer) {
        loader.textContent = 'Subiendo archivo...';
      }
      google.script.run
        .withSuccessHandler(function (response) {
          inputElement.disabled = false;
          document.getElementById('submit-button').disabled = false;

          if (progressInterval) clearInterval(progressInterval);

          if (response.status === 'OK') {
            urlHidden.value = response.url;
            if (progressContainer && progressBar) {
              progressBar.style.width = '100%';
              progressBar.textContent = '100%';
              progressBar.style.backgroundColor = '#28a745';
              setTimeout(() => {
                nombreLabel.textContent = file.name + ' (✅ Subido)';
              }, 500);
            } else {
              loader.className = 'loader-archivo exito';
              loader.textContent = '✅ Archivo subido con éxito.';
            }
          } else {
            if (progressContainer) progressContainer.style.display = 'none';
            loader.className = 'loader-archivo error';
            loader.textContent = `❌ Error: ${response.message}`;
            inputElement.value = '';
            nombreLabel.textContent = 'Ningún archivo seleccionado';
          }
        })
        .withFailureHandler(function (error) {
          inputElement.disabled = false;
          document.getElementById('submit-button').disabled = false;
          if (progressInterval) clearInterval(progressInterval);
          if (progressContainer) progressContainer.style.display = 'none';

          loader.className = 'loader-archivo error';
          loader.textContent = `❌ Error de conexión: ${error.message}`;
          inputElement.value = '';
          nombreLabel.textContent = 'Ningún archivo seleccionado';
        })
        .subirArchivoIndividual(fileData, dni, tipoArchivo);
    }).catch(err => {
      inputElement.disabled = false;
      document.getElementById('submit-button').disabled = false;
      if (progressInterval) clearInterval(progressInterval);
      if (progressContainer) progressContainer.style.display = 'none';

      loader.className = 'loader-archivo error';
      loader.textContent = `❌ Error al procesar el archivo: ${err.message}`;
      inputElement.value = '';
      nombreLabel.textContent = 'Ningún archivo seleccionado';
    });
  }
</script>